function updateDepthDomain(e,t){null!=e&&(depthDomain[0]=e),null!=t&&(depthDomain[1]=t),xScale=(()=>d3.scaleLinear().domain(depthDomain).range([0,columnWidth-50]))}function loadGalaxyData(e){d3.dsv(" ",galaxyFile,e=>({NSAID:e.NSAID,RA:+e.RA,DEC:+e.DEC,redshift:+e.redshift,mstars:e.mstars,sfr:e.sfr,sfr_err:e.sfr_err,rvir:e.rvir,log_sSFR:e.log_sSFR,color:e.color,position:sphericalToCartesian(e.RA,e.DEC,e.redshift),filID:e.filID,filNgal0p5:e.filNgal0p5,filNgal1p0:e.filNgal1p0})).then(t=>{console.log(t),processGalaxyData(t),galaxies=t,e()})}function loadProjections(){d3.json(projectionData).then(function(e){projections=e})}function loadP(e){-1!=e&&d3.json("data/projections/p"+e+".json").then(function(t){projections[e]=t,plotSkewerNeighbors()})}function loadLookUp(){d3.json("data/projections/lookUp.json").then(function(e){z_d=e})}function lookUp(e){let t=z_d.find(function(t){return t.z===e});return t?t.d:cosmcalc(e)}function loadCloseImpactLookUp(){d3.dsv(" ","data/galaxyCloseImpactLookup.dat").then(function(e){impactParameters=e})}function loadGalaxySubset1(){d3.dsv(" ","data/GalaxySubset1.dat",e=>(highlightCustomGalaxies(e.NSAID,1),{NSAID:+e.NSAID}))}function loadGalaxySubset2(){d3.dsv(" ","data/GalaxySubset2.dat",e=>(highlightCustomGalaxies(e.NSAID,2),{NSAID:+e.NSAID}))}function cosmcalc(e){let t=e;var r=73,a=.27,l=.73;let s=0,o=0,d=299792.458,c=977.8,p=.5,u=0,g=.5,x=0,h=.1,f=0,m=0,v=0,b=0,w=0,S=0,E=0,I=0,C=0,k=0,O=0,W=0,_=1,A=.5,H=r/100;for(s=4165e-8/(H*H),o=1-a-s-l,A=1/(1+1*t),g=0,n=1e3,i=0;i<n;i++){_=A*(i+.5)/n;let e=Math.sqrt(o+a/_+s/(_*_)+l*_*_);g+=1/e}for(h=A*g/n,f=c/r*h,p=0,m=0,i=0;i<n;i++){_=A+(1-A)*(i+.5)/n;let e=Math.sqrt(o+a/_+s/(_*_)+l*_*_);p+=1/e,m+=1/(_*e)}p=(1-A)*p/n,m=(1-A)*m/n,g=p+h,x=g*(c/r),u=c/r*p,b=c/r*m,v=d/r*m;let D=1,P=Math.sqrt(Math.abs(o))*m;if(P>.1?D=o>0?.5*(exp(P)-exp(-P))/P:sin(P)/P:(y=P*P,o<0&&(y=-y,D=1+y/6+y*y/120)),DCMT=D*m,w=A*DCMT,S=d/r*w,I=S/206.264806,E=c/r*w,C=w/(A*A),k=d/r*C,O=c/r*C,D=1,P=Math.sqrt(Math.abs(o))*m,P>.1)D=o>0?(.125*(exp(2*P)-exp(-2*P))-P/2)/(P*P*P/3):(P/2-sin(2*P)/4)/(P*P*P/3);else{let e=P*P;o<0&&(e=-e,D=1+e/5+2/105*e*e)}return VCM=D*m*m*m/3,W=4*Math.pi*(.001*d/r)**3*VCM,S}function roundtothree(e,t=!0){let r=parseFloat(e);return t?Math.round(1e3*r)/1e3:r}function roundtofive(e,t=!0){let r=parseFloat(e);return t?Math.round(1e5*r)/1e5:r}function loadSkewerData(e){d3.dsv(" ",skewerFile,e=>({name:e.name,RA:+e.RA,DEC:+e.DEC})).then(t=>{t.forEach(e=>{skewer.push(e.name),plotSkewer(e.name,e.RA,e.DEC);let t=[e.name]+".dat",r=["HI","CIV"];skewerData.set(e.name,{RA:+e.RA,DEC:+e.DEC,startPoint:sphericalToCartesian(e.RA,e.DEC,galaxy_redshift_min).clone(),endPoint:sphericalToCartesian(e.RA,e.DEC,galaxy_redshift_max).clone()}),r.forEach(r=>{let a="data/spectra_"+r+"_norm/";d3.dsv(" ",a+t,e=>({sig_norm:parseFloat(e.sig_norm),flux_norm:parseFloat(e.flux_norm),redshift:parseFloat(e.redshift),wavelength:parseFloat(e.wavelength)})).then(t=>{t.length>1&&(skewerData.get(e.name)[r]=t,skewer_redshift_min=skewerData.get(e.name)[r][0].redshift,skewer_redshift_min<depthDomain[0]&&null!=skewer_redshift_min&&(updateDepthDomain(skewer_redshift_min,void 0),createBrush(),createSlider()),skewer_redshift_max=skewerData.get(e.name)[r][skewerData.get(e.name)[r].length-1].redshift,skewer_redshift_max>depthDomain[1]&&null!=skewer_redshift_max&&(updateDepthDomain(void 0,skewer_redshift_max),createBrush(),createSlider()),"HI"===r&&createAbsorptionDataTexture(e.name))})})}),e()})}function haversine(e,t,r,a,l){let i=lookUp(l),s=e.toRad(),o=t.toRad(),n=(t-e).toRad(),d=(a-r).toRad(),c=Math.sin(n/2)*Math.sin(n/2)+Math.cos(s)*Math.cos(o)*Math.sin(d/2)*Math.sin(d/2),p=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),u=p*i;return roundtothree(u)}function exportData(e,t){const r=document.createElement("a"),a=e.split(".").pop();r.href=URL.createObjectURL(new Blob([t],{type:`text/${"txt"===a?"plain":a}`})),r.download=e,r.click()}function getQuasarGalaxyNeighbors(){let e=prevCylOverIdx,t=graphs.length;for(w=0;w<t;w++)if(-1!=e[w]){let t=skewer[e[w]],r=projections[e[w]];if(quasar_galaxy_neighbors[w]=[],quasar_galaxy_neighbors[w].push(skewerData.get(t)),r)for(let e=0;e<galaxies.length;++e){let t=r[e],a=galaxies[e];t<distanceFromSkewer&&quasar_galaxy_neighbors[w].push(a)}}}function veltrans(e,t,r){let a=299792.458,l=[],i=math.add(e,1),s=math.multiply(i,r),o=math.subtract(t,s),n=math.multiply(a,o),d=math.divide(n,r);if(r.length)for(ll=0;ll<r.length;ll++)l.push(a*(t[ll]-(1+e[ll])*ll)/ll/(1+e[ll]));else l=math.divide(d,i);return l}function EW_ACD_array(e,t,r,a,l=[-50,50],s="None",o=1215.67,n=.4164){let d=299792.458;if("None"==s)for(s=[],i=0;i<e.length;i++)s.push(1);let c=veltrans(a,e,o),p=[];for(v[0]=e[0],v[1]=e[e.length-1],l=veltrans(a,v,o),i=0;i<c.length;i++)c[i]>=l[0]&&c[i]<=l[1]&&p.push(i);let u=c[p[1]],g=c[p[0]],x=Math.abs(u-g),h=t;for(i=0;i<t.length;i++)t[i]<r[i]?(belowerr=i,i=t.length):belowerr=-1;h[belowerr]=r[belowerr];let f=[],y=[],m=[],b=[];for(i=0;i<p.length;i++){let e=x*(1-h[p[i]]/s[p[i]])*o/d,t=x/s[p[i]]*r[p[i]]*o/d,a=math.log(s[p[i]]/h[p[i]]),l=r[p[i]]/h[p[i]];f.push(e),y.push(t),m.push(a),b.push(l)}let w=math.multiply(1/2.654e-15/o/n*x,m),S=math.multiply(1/2.654e-15/o/n*x,b);return[f,y,w,S]}function EW_ACD(e,t,r,a,l=[-50,50],s="None",o=1215.67,n=.4164){if("None"==s)for(s=[],i=0;i<e.length;i++)s.push(1);let d=EW_ACD_array(e,t,r,a,l,s,o,n),c=d[0],p=d[1],u=d[2],g=d[3],x=math.sum(c),h=math.sum(u),f=0;for(i=0;i<p.length;i++)f+=math.pow(p[i],2);let y=math.sqrt(f);for(f=0,i=0;i<g.length;i++)f+=math.pow(g[i],2);let m=math.sqrt(f);return[x,y,h,m]}function pressLeft(){z_left=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('left boundary ✓, press "E"')}function pressRight(){z_right=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('right boundary ✓, press "E"')}function selectZ(){z_abs=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("center point selected"),getSkewerSpectra(),d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove()}function getSkewerSpectra(){let e=EW_selected[1];for(waves=[],fluxes=[],i=0;i<e.length;i++)if("HI"==e[i].key){let s=e[i].value;for(j=0;j<s.length;j++)reds[j]=s[j].redshift;var t=reds.indexOf(z_left),r=reds.indexOf(z_right);if(-1==r){goal=z_right;var a=reds.reduce(function(e,t){return Math.abs(t-goal)<Math.abs(e-goal)?t:e});r=reds.indexOf(a)}if(-1==t){goal=z_left;var l=reds.reduce(function(e,t){return Math.abs(t-goal)<Math.abs(e-goal)?t:e});t=reds.indexOf(l)}for(w=t;w<r;w++)waves.push(s[w].wavelength),fluxes.push(s[w].flux_norm),ferr.push(s[w].sig_norm)}let s=EW_ACD(waves,fluxes,ferr,z_abs,vellim=[-50,50],cont="None",restlam=1215.67,fosc=.4164);EW_all.push([EW_selected[0],s[0],reds[t],reds[r],s[1]]),EW_plot()}function EW_plot_init(){d3.select("#bottom-panel").selectAll("#EW-plot").select("#EWplot").remove();let e=d3.select("#bottom-panel").selectAll("#EW-plot").append("svg").attr("id","EWplot").attr("width",208).attr("height",200).style("fill","#1d1d1d");e.append("rect").attr("x",0).attr("y",0).attr("width",208).attr("height",200).attr("fill","#1d1d1d"),0==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('Press "E" to start')),EW_plot()}function EW_plot(){for(neighbors=[],i=0;i<EW_all.length;i++){let e=filterNeighborsEW(EW_all[i][1],EW_all[i][2],EW_all[i][3],EW_all[i][0],EW_all[i][4]);e&&neighbors.push(e)}d3.select("body").select("#bottom-panel").select("#EW-plot").select("#EWplot").selectAll("g").remove();var e=d3.scaleLinear().domain([0,distanceFromSkewer]).range([0,150]),t=d3.scaleLinear().domain([1.2,0]).range([0,130]),r=d3.select("body").select("#bottom-panel").select("#EW-plot").select("#EWplot").append("svg").append("g").attr("transform","translate(45,180)"),a=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),l=d3.axisBottom().scale(e).ticks(6),s=d3.axisLeft().scale(t).ticks(5);r.append("g").attr("class","xAxis").attr("transform","translate(0,-20)").call(l),r.append("text").text("Impact Parameter (Mpc)").style("fill","white").attr("font-size","11px").attr("transform","translate(8,12)"),r.append("g").attr("class","yAxis").call(s).attr("transform","translate(0,-150)"),r.append("text").text("Equivalent Width (Å)").attr("transform","rotate(-90)").attr("y",-30).attr("x",35).style("fill","white").attr("font-size","11px"),r.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-line").attr("x1",function(t){return e(t.ip)}).attr("y1",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r-.1)-150}return t(e.ew+e.sigEWf)-150}).attr("x2",function(t){return e(t.ip)}).attr("y2",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r)-150}return t(e.ew-e.sigEWf)-150}).attr("stroke",function(e){return"blue"==e.color?"#00aeff":"#ff0000"}),r.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(t){if(!(t.ew<3*t.sigEWf))return e(t.ip)-4}).attr("y1",function(e){if(!(e.ew<3*e.sigEWf))return t(e.ew+e.sigEWf)-150}).attr("x2",function(t){if(!(t.ew<3*t.sigEWf))return e(t.ip)+4}).attr("y2",function(e){if(!(e.ew<3*e.sigEWf))return t(e.ew+e.sigEWf)-150}).attr("stroke",function(e){return"blue"==e.color?"#00aeff":"#ff0000"}),r.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(t){return e(t.ip)-4}).attr("y1",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r-.1)-154}return t(e.ew-e.sigEWf)-150}).attr("x2",function(t){return t.ew<3*t.sigEWf?e(t.ip):e(t.ip)+4}).attr("y2",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r-.1)-150}return t(e.ew-e.sigEWf)-150}).attr("stroke",function(e){return"blue"==e.color?"#00aeff":"#ff0000"}),r.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(t){if(t.ew<3*t.sigEWf)return e(t.ip)}).attr("y1",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r-.1)-150}}).attr("x2",function(t){if(t.ew<3*t.sigEWf)return e(t.ip)+4}).attr("y2",function(e){if(e.ew<3*e.sigEWf){let r=3*e.sigEWf;return t(r-.1)-154}}).attr("stroke",function(e){return"blue"==e.color?"#00aeff":"#ff0000"}),r.selectAll(".dot").data(neighbors).enter().append("circle").attr("class","dot").attr("r",2).attr("cx",function(t){return e(t.ip)}).attr("cy",function(e){return e.ew<3*e.sigEWf?t(3*e.sigEWf)-150:t(e.ew)-150}).attr("fill",function(e){return"blue"==e.color?"#00aeff":"#ff0000"}).on("mouseover",function(e){a.transition().duration(200).style("opacity",.75),a.html("QSO: "+e.skewer+"<br/> NSAID: "+e.NSAID+"<br/> IP: "+e.ip+" Mpc <br/> EW: "+roundtofive(e.ew)+" Å <br/> zmin: "+e.zmin+"<br/> zmax: "+e.zmax+"<br/> zabs: "+e.zabs+"<br/> velmin: "+e.velmin+" km/s <br/> velmax: "+e.velmax+"km/s").style("left",d3.event.pageX-25+"px").style("top",d3.event.pageY-170+"px");var t=galaxies[e.gidx];currentGalaxy=[t,e.gidx],plotGalaxyImage(e.gidx),plotSkewerNeighbors()}).on("mouseout",function(e){a.transition().duration(200).style("opacity",0)})}function colorFilament(e,t){if(e&&!t)for(i=0;i<galaxies.length;i++)(galaxies[i].NSAID=e)&&(selectedFilID=galaxies[i].filID);else!e&&t?selectedFilID=t:e&&t&&(selectedFilID=t);for(i=0;i<galaxies.length;i++)if(filMode&&-99!=galaxies[i].filID&&galaxies[i].filID==selectedFilID)boxOfPoints.geometry.attributes.customColor.array[i]=2;else{for("blue"==galaxies[i].color?boxOfPoints.geometry.attributes.customColor.array[i]=1:"red"==galaxies[i].color&&(boxOfPoints.geometry.attributes.customColor.array[i]=0),j=0;j<galaxySubset1.length;j++)galaxySubset1[j].NSAID==parseInt(galaxies[i].NSAID)&&(boxOfPoints.geometry.attributes.customColor.array[i]=3,cs[i]=1);for(j=0;j<galaxySubset2.length;j++)galaxySubset2[j].NSAID==parseInt(galaxies[i].NSAID)&&(boxOfPoints.geometry.attributes.customColor.array[i]=4,cs[i]=1)}if(filMode)for(i=0;i<galaxiesInFilaments.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxiesInFilaments[i]]=2;boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,boxOfPoints.geometry.attributes.customColor.needsUpdate=!0}function colFil(e,t){if(!e&&t)selectedFilID=t;else if(e&&t)selectedFilID=t;else if(e&&!t)for(i=0;i<galaxies.length;i++)galaxies[i].NSAID==e&&(selectedFilID=galaxies[i].filID);for(i=0;i<galaxies.length;i++)-99!=galaxies[i].filID&&galaxies[i].filID==selectedFilID?(galaxiesInFilaments.push(i),boxOfPoints.geometry.attributes.customColor.array[i]=2):galaxies[i].NSAID==e&&1===groupNumber?(galaxySubset1.push(i),boxOfPoints.geometry.attributes.customColor.array[i]=3,cs[i]=1):galaxies[i].NSAID==e&&2===groupNumber?(galaxySubset2.push(i),boxOfPoints.geometry.attributes.customColor.array[i]=4,cs[i]=1):("blue"==galaxies[i].color&&(boxOfPoints.geometry.attributes.customColor.array[i]=1),"red"==galaxies[i].color&&(boxOfPoints.geometry.attributes.customColor.array[i]=0));for(i=0;i<galaxiesInFilaments.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxiesInFilaments[i]]=2;boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,boxOfPoints.geometry.attributes.customColor.needsUpdate=!0}function highlightCustomGalaxies(e,t){var r=boxOfPoints.geometry.attributes.isSelected.array;for(i=0;i<galaxies.length;i++)galaxies[i].NSAID==e&&1===t?(galaxySubset1.push(i),boxOfPoints.geometry.attributes.customColor.array[i]=3,r[i]=1):galaxies[i].NSAID==e&&2===t?(galaxySubset2.push(i),boxOfPoints.geometry.attributes.customColor.array[i]=4,r[i]=1):("blue"==galaxies[i].color&&(boxOfPoints.geometry.attributes.customColor.array[i]=1),"red"==galaxies[i].color&&(boxOfPoints.geometry.attributes.customColor.array[i]=0));for(i=0;i<galaxySubset1.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxySubset1[i]]=3,r[i]=1;for(i=0;i<galaxySubset2.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxySubset2[i]]=4,r[i]=1;boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,boxOfPoints.geometry.attributes.customColor.needsUpdate=!0}function hideCustomGalaxies(){var e=boxOfPoints.geometry.attributes.isSelected.array;for(j=0;j<galaxies.length;j++)"blue"==galaxies[j].color&&(boxOfPoints.geometry.attributes.customColor.array[j]=1),"red"==galaxies[j].color&&(boxOfPoints.geometry.attributes.customColor.array[j]=0),e[j]=0;boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,boxOfPoints.geometry.attributes.customColor.needsUpdate=!0}function filterNeighborsEW(e,t,r,a,l){let i,s=t,o=r,n=skewer.indexOf(a);if(quasar_galaxy_EW_neighbors=[],-1!=n){skewer[n];let i=projections[n];if(i)for(let n=0;n<galaxies.length;++n){let c=i[n],p=galaxies[n];if(c<distanceFromSkewer&&s<p.redshift&&o>p.redshift){var d={skewer:a,NSAID:p.NSAID,zmin:t,zmax:r,ip:+c[0],ew:e,zabs:z_abs,velmin:v[0],velmax:v[1],gidx:n,color:p.color,sigEWf:l};quasar_galaxy_EW_neighbors.includes(d)||quasar_galaxy_EW_neighbors.push(d)}}}return i=quasar_galaxy_EW_neighbors.sort(function(e,t){return e.ip-t.ip}),i[0]}function mapKeyPressToActualCharacter(e,t){return"boolean"==typeof e&&"number"==typeof t&&(e?characterMapShift[t]:characterMap[t])}function onKeyDown(e){var t=String.fromCharCode(e.keyCode);KeyboardEvent.shiftKey;"E"==t&&(E_pressed=!0,0==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select left boundary")),1==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select right boundary")),2==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select center point"))),"F"==t&&(filMode=!filMode),"G"==t?selectedGalaxies.includes(currentGalaxy[1])||(d3.select("#bottom-panel").selectAll("#imageSaveInstructions").remove(),selectedGalaxies.push(currentGalaxy[1]),trigger=!0,plotGalaxyImage(currentGalaxy[1],trigger),trigger=!1):"N"==t?loadAllP(toggleGalaxiesNearSkewers):"S"==t?(cylinderGroup.visible=!cylinderGroup.visible,cylinderBackGroup.visible=!cylinderBackGroup.visible):"T"==t?textGroup.visible=!textGroup.visible:"Z"==t&&zoomToGalaxy(),"1"!=t||e.shiftKey?"2"!=t||e.shiftKey?"3"!=t||e.shiftKey?"4"!=t||e.shiftKey?"5"!=t||e.shiftKey?"6"!=t||e.shiftKey?"7"!=t||e.shiftKey?"8"!=t||e.shiftKey?"9"!=t||e.shiftKey?"1"==t&&e.shiftKey?(-1==prevCylOverIdx[10]?prevCylOverIdx[10]=prevCylOverIdx[0]:(prevCylOverIdx[10]=-1,unselectSkewer()),plotSkewerSpectra()):"2"==t&&e.shiftKey?(-1==prevCylOverIdx[11]?prevCylOverIdx[11]=prevCylOverIdx[0]:(prevCylOverIdx[11]=-1,unselectSkewer()),plotSkewerSpectra()):"3"==t&&e.shiftKey?(-1==prevCylOverIdx[12]?prevCylOverIdx[12]=prevCylOverIdx[0]:(prevCylOverIdx[12]=-1,unselectSkewer()),plotSkewerSpectra()):"4"==t&&e.shiftKey?(-1==prevCylOverIdx[13]?prevCylOverIdx[13]=prevCylOverIdx[0]:(prevCylOverIdx[13]=-1,unselectSkewer()),plotSkewerSpectra()):"5"==t&&e.shiftKey?(-1==prevCylOverIdx[14]?prevCylOverIdx[14]=prevCylOverIdx[0]:(prevCylOverIdx[14]=-1,unselectSkewer()),plotSkewerSpectra()):"6"==t&&e.shiftKey?(-1==prevCylOverIdx[15]?prevCylOverIdx[15]=prevCylOverIdx[0]:(prevCylOverIdx[15]=-1,unselectSkewer()),plotSkewerSpectra()):"7"==t&&e.shiftKey?(-1==prevCylOverIdx[16]?prevCylOverIdx[16]=prevCylOverIdx[0]:(prevCylOverIdx[16]=-1,unselectSkewer()),plotSkewerSpectra()):"8"==t&&e.shiftKey?(-1==prevCylOverIdx[17]?prevCylOverIdx[17]=prevCylOverIdx[0]:(prevCylOverIdx[17]=-1,unselectSkewer()),plotSkewerSpectra()):"9"==t&&e.shiftKey&&(-1==prevCylOverIdx[18]?prevCylOverIdx[18]=prevCylOverIdx[0]:(prevCylOverIdx[18]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[9]?prevCylOverIdx[9]=prevCylOverIdx[0]:(prevCylOverIdx[9]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[8]?prevCylOverIdx[8]=prevCylOverIdx[0]:(prevCylOverIdx[8]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[7]?prevCylOverIdx[7]=prevCylOverIdx[0]:(prevCylOverIdx[7]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[6]?prevCylOverIdx[6]=prevCylOverIdx[0]:(prevCylOverIdx[6]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[5]?prevCylOverIdx[5]=prevCylOverIdx[0]:(prevCylOverIdx[5]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[4]?prevCylOverIdx[4]=prevCylOverIdx[0]:(prevCylOverIdx[4]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[3]?prevCylOverIdx[3]=prevCylOverIdx[0]:(prevCylOverIdx[3]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[2]?prevCylOverIdx[2]=prevCylOverIdx[0]:(prevCylOverIdx[2]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[1]?prevCylOverIdx[1]=prevCylOverIdx[0]:(prevCylOverIdx[1]=-1,unselectSkewer()),plotSkewerSpectra())}function selectPoint(){for(var e=boxOfPoints.geometry.attributes.isSelected.array,t=0;t<e.length;t++)e[t]=0;for(i=0;i<galaxySubset1.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxySubset1[i]]=3,e[galaxySubset1[i]]=1;for(i=0;i<galaxySubset2.length;i++)boxOfPoints.geometry.attributes.customColor.array[galaxySubset2[i]]=4,e[galaxySubset2[i]]=1;e[pointOverIdx]=1,prevPointOverIdx=pointOverIdx,boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,plotGalaxyImage(pointOverIdx),filMode&&colorFilament(galaxies[pointOverIdx].NSAID,galaxies[pointOverIdx].filID)}function unselectPoint(){for(var e=boxOfPoints.geometry.attributes.isSelected.array,t=0;t<e.length;t++)e[t]=0;for(i=0;i<galaxySubset1.length;i++)e[galaxySubset1[i]]=1;for(i=0;i<galaxySubset2.length;i++)e[galaxySubset2[i]]=1;prevPointOverIdx=-1,boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0}function selectSkewer(){for(-1!=cylOverIdx?(cyl_0=cylinderGroup.children[cylOverIdx],cyl_0.geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0):-1!=prevCylOverIdx[0]&&(cyl_0=cylinderGroup.children[prevCylOverIdx[0]],cyl_0.geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0),i=1;i<prevCylOverIdx.length;i++)-1!=prevCylOverIdx[i]&&(cyl[i]=cylinderGroup.children[prevCylOverIdx[i]],cyl[i].geometry.attributes.isSelected.set(Array(192).fill(1)),cyl[i].geometry.attributes.isSelected.needsUpdate=!0)}function unselectSkewer(){for(i=1;i<prevCylOverIdx.length;i++)cyl[i]&&-1==prevCylOverIdx[i]&&(cyl[i].geometry.attributes.isSelected.set(Array(192).fill(0)),cyl[i].geometry.attributes.isSelected.needsUpdate=!0);cyl_0&&(cyl_0.geometry.attributes.isSelected.set(Array(192).fill(0)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0),-1!=cylOverIdx&&(cyl_0=cylinderGroup.children[cylOverIdx],cyl_0.geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0)}function onMouseMove(e){let t=e.clientX,r=e.clientY;if(mouse.x=t/(window.innerWidth-columnWidth)*2-1,mouse.y=-r/(window.innerHeight-200)*2+1,raycaster.setFromCamera(mouse,camera),mouse.y>-1&&mouse.x<1){var a=raycaster.intersectObjects(scene.children);pointOverIdx=-1;for(var l=0;l<a.length;l++){var i=a[l];if("Points"==i.object.type&&i.distanceToRay<.4){pointOverIdx=i.index;break}}pointOverIdx>=0&&pointOverIdx!=prevPointOverIdx&&(selectPoint(),plotSkewerSpectra(),plotGalaxyImage(pointOverIdx)),pointOverIdx<0&&prevPointOverIdx>=0&&unselectPoint(),a=raycaster.intersectObjects(cylinderGroup.children),-1!=cylOverIdx&&(prevCylOverIdx[0]=cylOverIdx,plotSkewerSpectra()),cylOverIdx=-1;for(l=0;l<a.length;l++){i=a[l];1==cylinderGroup.visible&&"Mesh"==i.object.type&&(cylOverIdx=cylinderGroup.children.indexOf(i.object))}cylOverIdx>-1&&!prevCylOverIdx.includes(cylOverIdx)&&(unselectSkewer(),selectSkewer(),plotSkewerSpectra())}}function createGraph(e){let t=columnWidth-50,r=e;var a=[];for(i=0;i<r;i++){let e=d3.select("#details").select("#graphs").append("div").attr("id","graph"+i).append("svg").attr("width",t+50).attr("height",graphHeight+50).append("g").attr("transform","translate(25, 25)");e.append("rect").attr("class","graph-background").attr("x",0).attr("y",0).attr("width",t).attr("height",graphHeight),i>0&&(e.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(i),e.append("text").attr("class","skewerSaveInstructions").attr("x",columnWidth/4).attr("y",100).text("Press "+i+" to save selected skewer")),a[i]=e}return a}function plotSkewerSpectra(){i=prevCylOverIdx;let e=graphs.length;for(w=0;w<e;w++){projections[i[w]]||loadP(i[w]);let e=graphs[w],t=skewer[i[w]],r=d3.entries(skewerData.get(t)),a=xScale(),l=yScale();if(-1==i[w]&&(e.selectAll("graph"+w+"_border").remove(),d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".xaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".title").remove(),d3.select("#details").select("#graph"+w).selectAll("#border").remove(),e.selectAll(".penHI").remove(),e.selectAll(".penCIV").remove(),e.selectAll(".mark").remove(),e.selectAll(".graphNumber").remove(),e.selectAll(".skewerSaveInstructions").remove(),w>0&&(e.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(w),e.append("text").attr("class","skewerSaveInstructions").attr("x",columnWidth/4).attr("y",100).text("Press "+w+" to save selected skewer"))),-1!=i[w]){let t=i[w];if(-1!=pointOverIdx){let e=pointOverIdx;galaxies[e]}e.selectAll("graph"+w+"_border").remove(),d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".xaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".title").remove(),d3.select("#details").select("#graph"+w).selectAll("#border").remove(),e.selectAll(".graphNumber").remove(),e.selectAll(".skewerSaveInstructions").remove(),e.selectAll(".penHI").remove(),e.selectAll(".penCIV").remove(),e.selectAll(".skewerSaveInstructions").remove();let s=d3.line().x(e=>a(e.redshift)).y(e=>l(e.flux_norm));r.forEach(i=>{if(e.selectAll(".pen"+i.key).remove(),e.selectAll(".pen"+i.key+"invis").remove(),e.selectAll("#border").remove(),"HI"==i.key||"CIV"==i.key)e.append("path").attr("class","pen"+i.key).datum(i.value).attr("d",s).attr("fill","none"),e.append("path").attr("class","pen"+i.key+"invis").datum(i.value).attr("d",s).attr("fill","none").on("click",function(){var e=a.invert(d3.mouse(this)[0]),s=l.invert(d3.mouse(this)[1]);EW_coord=[roundtofive(e),roundtofive(s)],E_pressed&&"HI"==i.key&&(EW_selected=[skewer[t],r],0==EW_stat?(pressLeft(),EW_stat=1,E_pressed=!1):1==EW_stat?(pressRight(),EW_stat=2,E_pressed=!1):2==EW_stat&&(EW_stat=0,E_pressed=!1,selectZ()))});e.append("rect").attr("id","border").attr("transform","translate(-40,-20)").attr("width",columnWidth+20).attr("height",graphHeight+50),w>0&&e.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(w);let o=r.length-4;1!=o||"HI"!=i.key&&"CIV"!=i.key?2==o&&(d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),e.selectAll(".penHI").attr("transform","translate(0,"+graphHeight/8+")"),e.selectAll(".penHIinvis").attr("transform","translate(0,"+graphHeight/8+")"),e.selectAll(".penCIV").attr("transform","translate(0,"+-1*graphHeight/3+")"),e.selectAll(".penCIVinvis").attr("transform","translate(0,"+-1*graphHeight/3+")"),e.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+3*graphHeight/4+") rotate(-90)").style("text-anchor","middle").text("HI"),e.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+graphHeight/4+") rotate(-90)").style("text-anchor","middle").text("CIV")):e.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+graphHeight/2+") rotate(-90)").style("text-anchor","middle").text(i.key),d3.selectAll("text").attr("stroke","none").attr("fill","white")})}e.append("g").attr("class","xaxis").attr("transform","translate(0,"+graphHeight+")").attr("stroke","white").call(d3.axisBottom(a).ticks(6)).selectAll("text").attr("stroke","none").attr("fill","white"),e.append("text").attr("class","title").attr("transform","translate("+(columnWidth-50)/2+", -7)").attr("text-anchor","middle").attr("fill","white").text(t)}unselectSkewer(),selectSkewer(),plotSkewerNeighbors()}function plotSkewerNeighbors(){let e=prevCylOverIdx,t=graphs.length;for(d3.select("#box-height").on("change",function(e){boxHeight=d3.select(this).property("value"),plotSkewerNeighbors()}),d3.select("#box-width").on("change",function(e){boxWidth=d3.select(this).property("value"),plotSkewerNeighbors()}),w=0;w<t;w++){let t=graphs[w];if(-1!=e[w]){skewer[e[w]];let r=projections[e[w]];if(t.selectAll(".mark").remove(),r)for(let e=0;e<galaxies.length;++e){let a=r[e],l=galaxies[e];if(a<distanceFromSkewer){let r=l.redshift;"dist"==boxWidth?halfWidth=10/a:"rvir"==boxWidth?halfWidth=10*l.rvir:"sfr"==boxWidth?halfWidth=10*l.sfr:"mstars"==boxWidth?halfWidth=2*l.mstars:"onePx"==boxWidth&&(halfWidth=2),"dist"==boxHeight?halfSize=10/a:"rvir"==boxHeight?halfSize=10*l.rvir:"sfr"==boxHeight?halfSize=10*l.sfr:"mstars"==boxHeight&&(halfSize=2*l.mstars),t.append("rect").attr("class","mark g"+e).attr("x",xScale()(r)-halfWidth/2).attr("y",graphHeight/2-halfSize).attr("width",halfWidth).attr("height",2*halfSize).attr("opacity",.85).datum(e).style("fill",e=>currentGalaxy[1]&&currentGalaxy[1]==e?"#00ff00":selectedGalaxies.includes(e)?"blue"==galaxies[e].color?"#00aeff":"#ff0000":void 0).on("mouseover",e=>{pointOverIdx=e,selectPoint(),plotGalaxyImage(pointOverIdx),plotSkewerSpectra()}).on("mouseout",e=>{prevPointOverIdx=e,unselectPoint()})}}}}}function plotGalaxyImage(e){var t=galaxies[e];currentGalaxy=[t,e];let r=["NSAID: "+t.NSAID,"DEC = "+t.DEC,"RA = "+t.RA,"mstars = "+t.mstars,"sfr = "+t.sfr,"sfr_err = "+t.sfr_err,"redshift: "+t.redshift,"rvir: "+t.rvir,"log_sSFR: "+t.log_sSFR];if(trigger){a=d3.select("#selectedGalaxies").append("div").attr("id","galaxyDesc"+t.NSAID).attr("class","galaxyQueue galaxyQueue-Desc"),l=d3.select("#selectedGalaxies").append("div").attr("id","galaxyImage"+t.NSAID).attr("class","galaxyQueue");l.append("img").attr("src","data/galaxyImages/"+t.NSAID+".jpg").attr("height","160px").attr("padding","10px").on("mouseover",e=>{pointOverIdx=e,selectPoint()}).on("mouseout",e=>{prevPointOverIdx=e,unselectPoint()}),a.selectAll("p").data(r).enter().append("p").style("width","150px").text(e=>e),l.selectAll("img").on("mouseover",t=>{pointOverIdx=e;let r=galaxies[e];currentGalaxy=[r,e],plotSkewerNeighbors(),selectPoint()}).on("mouseout",t=>{prevPointOverIdx=e,unselectPoint()}),$("div#selectedGalaxies").animate({scrollLeft:"0"},400)}else{var a=d3.select("#galaxyDesc"),l=d3.select("#galaxyImage");a.select("div").remove(),l.select("div").remove();var i=a.append("div");i.selectAll("p").data(r).enter().append("p").text(e=>e);var s=l.append("div");s.append("img").attr("src","data/galaxyImages/"+t.NSAID+".jpg").attr("width","160px").on("mouseover",t=>{pointOverIdx=e,selectPoint(),plotSkewerNeighbors()}).on("mouseout",t=>{prevPointOverIdx=e,unselectPoint()})}}function createSlider(e=distanceFromSkewer){let t=columnWidth-columnWidth/4,r=20;d3.select("#details").selectAll("#neighbor-slider").remove();let a=d3.select("#details").append("div").attr("id","neighbor-slider").append("svg");a.attr("width",t+80).attr("height",30),a.append("rect").attr("class","slider-track").attr("x",r).attr("y",12.5).attr("width",t-2*r).attr("height",5).style("fill","gray");let l=d3.scaleLinear().range([r,t-r]).domain([0,10]).clamp(!0);a.append("text").attr("id","slider-value").attr("x",t).attr("y",17.5).text(e+" Mpc").style("fill","white");let i=d3.drag().on("drag",function(){if(0===d3.event.dx)return;let e=d3.event.x;e=e<r?r:e>t-r?t-r:e,d3.select(this).attr("cx",e);let i=l.copy().invert(e);a.select("#slider-value").text(roundtothree(i)+" Mpc"),distanceFromSkewer=i,filterDistantGalaxies&&filterGalaxiesNearSkewers(),plotSkewerNeighbors(),EW_plot()});a.append("g").append("circle").attr("class","slider-handle").attr("cx",l(e)).attr("cy",15).attr("r",10).style("fill","white").style("stroke","gray").style("stroke-width",2.5).call(i).on("dblclick",()=>{loadAllP(toggleGalaxiesNearSkewers),a.select(".slider-handle").style("fill",()=>filterDistantGalaxies?"black":"white")})}function createBrush(){function e(){var e=columnWidth-l.right,t=60,r=e/t,s=columnWidth,c=s/r;o=s,n=c-l.bottom,a.attr("width",e).attr("height",t).attr("viewBox","0 0 "+s+" "+c),d.range([l.left,o-l.right]),i.attr("transform","translate(0,"+n+")").call(d3.axisBottom(d).ticks(6))}function t(){if(!d)return;let e=d3.brushX().extent([[l.left,0],[o-l.right,n]]).on("brush end",r);s.call(e).call(e.move,d.range())}function r(){var e=d3.event.selection||d.range();ret=e.map(d.invert,d),ret[0]!==ret[1]&&(updateDepthDomain(ret[0],ret[1]),-1!==prevCylOverIdx[0]&&-1!==prevCylOverIdx[0]&&(plotSkewerSpectra(),plotSkewerNeighbors()),filterBrushedGalaxies())}d3.select("#details").selectAll("#depth-brush").remove();let a=d3.select("#details").append("div").attr("id","depth-brush").append("svg"),l={top:5,left:20,bottom:20,right:20},i=a.append("g"),s=a.append("g").attr("class","brush"),o=0,n=0,d=d3.scaleLinear().domain(depthDomain).range([l.left,o-1]);e(),t()}function processOptions(e){let t={skewerData:e=>{skewerFile=e},galaxyData:e=>{galaxyFile=e},projectionData:e=>{projectionData=e},lookUpTable:e=>{lookUpTable=e},galaxyRvirScalar:e=>{galaxyRvirScalar=parseFloat(e)},galaxyRedHSL:e=>{galaxyRedHSL=e},
galaxyBlueHSL:e=>{galaxyBlueHSL=e},skewerWidth:e=>{skewerWidth=parseFloat(e)},skewerAbsorptionMinHSL:e=>{skewerAbsorptionMinHSL=e},skewerAbsorptionMaxHSL:e=>{skewerAbsorptionMaxHSL=e},skewerLinearFiltering:e=>{skewerLinearFiltering="true"==e},boxRadius:e=>{boxRadius=e},cameraFocalPoint:e=>{var t=e.split(",");cameraFocalPoint=new THREE.Vector3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),controls.enableZoom=!1,controls.target=cameraFocalPoint,controls.update()},cameraPositionX:e=>{camera.position.x=e},cameraPositionY:e=>{camera.position.y=e},cameraPositionZ:e=>{camera.position.z=e}};d3.text("options.txt").then(r=>{let a=r.split("\n");for(var l=0;l<a.length;l++){var i=a[l].split("="),s=i[0],o=i[1];s in t&&t[s](o)}e()})}function sphericalToCartesian(e,t,r){var a=e*(Math.PI/180),l=t*(Math.PI/180);let i=lookUp(parseFloat(r));var s=new THREE.Spherical(i,l,a),o=-s.radius*Math.cos(s.phi)*Math.sin(s.theta),n=s.radius*Math.cos(s.phi)*Math.cos(s.theta),d=s.radius*Math.sin(s.phi),c=new THREE.Vector3(o,n,d);return c}function zoomToGalaxy(){pos=currentGalaxy[0],poss=sphericalToCartesian(pos.RA,pos.DEC,.9*pos.redshift),camera.position.set(poss.x,poss.y,poss.z),camera.lookAt(pos.position.x,pos.position.y,pos.position.z)}function processGalaxyData(e){for(var t=e.length,r=new Float32Array(3*t),a=new Float32Array(1*t),l=new Float32Array(1*t),i=new Float32Array(1*t),s=new Float32Array(t),o=0;o<t;++o){a[o]=0,i[o]=1;let t=e[o];var n=new THREE.Vector3(e[o].position.x,e[o].position.y,e[o].position.z);n.toArray(r,3*o),"red"==t.color?l[o]=0:"blue"==t.color&&(l[o]=1),filMode&&selectedFilID==t.filID&&(l[o]=2),galaxySubset1.includes(o)&&(l[o]=3),galaxySubset2.includes(o)&&(l[o]=4),s[o]=t.rvir}var d=new THREE.BufferGeometry;d.addAttribute("position",new THREE.BufferAttribute(r,3)),d.addAttribute("customColor",new THREE.BufferAttribute(l,1)),d.addAttribute("isSelected",new THREE.BufferAttribute(a,1)),d.addAttribute("isVisible",new THREE.BufferAttribute(i,1)),d.addAttribute("size",new THREE.BufferAttribute(s,1));var c=new THREE.ShaderMaterial({uniforms:{amplitude:{value:1},color:{value:new THREE.Color(16777215)},redColor:{value:new THREE.Color(galaxyRedHSL)},blueColor:{value:new THREE.Color(galaxyBlueHSL)},filamentColor:{value:new THREE.Color(galaxyFilamentHSL)},group1Color:{value:new THREE.Color(galaxySubset1HSL)},group2Color:{value:new THREE.Color(galaxySubset2HSL)},texture:{value:tex1},galaxyRvirScalar:{value:galaxyRvirScalar}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0});boxOfPoints=new THREE.Points(d,c),scene.add(boxOfPoints)}function filterBrushedGalaxies(){if(1==filterbyIP)for(let e=0;e<impactParameters.length;++e){let t=impactParameters[e].smallestImpact/1e3;t<distanceFromSkewer&&galaxies[e].redshift>depthDomain[0]&&galaxies[e].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[e]=1:boxOfPoints.geometry.attributes.isVisible.array[e]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}else for(i=0;i<galaxies.length;i++)galaxies[i].redshift>depthDomain[0]&&galaxies[i].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[i]=1:boxOfPoints.geometry.attributes.isVisible.array[i]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}function filterGalaxiesNearSkewers(){filterbyIP=!0;for(let e=0,t=impactParameters.length;e<t;++e){let t=impactParameters[e].smallestImpact/1e3;t<distanceFromSkewer&&galaxies[e].redshift>depthDomain[0]&&galaxies[e].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[e]=1:boxOfPoints.geometry.attributes.isVisible.array[e]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}}function unfilterGalaxiesNearSkewers(){filterbyIP=!1;for(var e=0,t=galaxies.length;e<t;e++)boxOfPoints.geometry.attributes.isVisible.array[e]=1;boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}function loadAllP(e){if(!allLoaded)for(allLoaded=!0,n=0,len=skewer.length;n<len;n++)loadP(n);allLoaded=!0,e()}function toggleGalaxiesNearSkewers(){filterDistantGalaxies=!filterDistantGalaxies,filterDistantGalaxies?filterGalaxiesNearSkewers():unfilterGalaxiesNearSkewers()}function plotSkewer(e,t,r){var a=new THREE.ShaderMaterial({uniforms:{amplitude:{value:1},color:{value:new THREE.Color(16777215)},texture:{value:null}},vertexShader:document.getElementById("cyl_vertexshader").textContent,fragmentShader:document.getElementById("cyl_fragmentshader").textContent,depthTest:!0,transparent:!1,side:THREE.FrontSide});galaxy_redshift_min=galaxies.reduce((e,t)=>t.redshift<e?t.redshift:e,galaxies[0].redshift),galaxy_redshift_min<depthDomain[0]&&(depthDomain[0]=galaxy_redshift_min),galaxy_redshift_max=galaxies.reduce((e,t)=>t.redshift>e?t.redshift:e,galaxies[0].redshift),galaxy_redshift_max>depthDomain[1]&&(depthDomain[1]=galaxy_redshift_max);var l=sphericalToCartesian(t,r,galaxy_redshift_min).clone(),i=sphericalToCartesian(t,r,galaxy_redshift_max).clone(),s=l.distanceTo(i),o=new THREE.CylinderBufferGeometry(skewerWidth,skewerWidth,s,32,1,!0);o.translate(0,s/2,0),o.rotateX(Math.PI/2),o.addAttribute("isSelected",new THREE.BufferAttribute(new Float32Array(192).fill(0),1));var n=new THREE.Mesh(o,a);n.position.copy(l),n.lookAt(i),n.userData.name=e;var d=new THREE.Mesh(o,a);if(d.position.copy(l),d.lookAt(i),cylinderGroup.add(n),cylinderBackGroup.add(d),showLabels){let t=new THREE.TextSprite({textSize:.5,redrawInterval:250,texture:{text:e,fontFamily:"Karla, Avenir, monospace, Arial, Helvetica, sans-serif",textAlign:"left"},material:{color:16777215,fog:!1,transparent:!0,opacity:.9}});t.position.setX(l.x).setY(l.y).setZ(l.z),textGroup.add(t)}}function init(){renderer=new THREE.WebGLRenderer,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth-columnWidth,window.innerHeight-200),renderer.antialias=!0,camera=new THREE.PerspectiveCamera(54,(window.innerWidth-columnWidth)/(window.innerHeight-200),.01,1e4),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.maxAzimuthAngle=1/0,controls.maxPolarAngle=1/0,controls.dampingFactor=.4,camera.maxDistance=1/0,scene=new THREE.Scene,scene.background=new THREE.Color(328965),cylinderGroup=new THREE.Group,cylinderBackGroup=new THREE.Group,textGroup=new THREE.Group,scene.add(cylinderGroup),scene.add(cylinderBackGroup),scene.add(textGroup),processOptions(()=>{loadGalaxyData(()=>loadSkewerData()),displayGui()}),createBrush(),createSlider(),window.addEventListener("resize",onWindowResize,!1),document.addEventListener("mousemove",onMouseMove,!1),window.addEventListener("wheel",onMouseWheel,!1),document.addEventListener("keydown",onKeyDown,!1);var e=document.getElementById("container");e.appendChild(renderer.domElement),EW_plot_init()}function onMouseWheel(e){let t=e.clientX,r=e.clientY;if(mouse.x=t/(window.innerWidth-columnWidth)*2-1,mouse.y=-r/(window.innerHeight-200)*2+1,mouse.y>-1&&mouse.x<1){var a=4,l=new THREE.Vector3(mouse.x,mouse.y,1);l.unproject(camera),l.sub(camera.position),e.deltaY<0?(camera.position.addVectors(camera.position,l.setLength(a)),controls.target.addVectors(controls.target,l.setLength(a))):(camera.position.subVectors(camera.position,l.setLength(a)),controls.target.subVectors(controls.target,l.setLength(a)))}}function displayGui(){gui=new dat.GUI({width:columnWidth/2}),gui.domElement.id="dat-gui";var e=new THREE.Color(galaxyRedHSL),t=new THREE.Color(galaxyBlueHSL),r=new THREE.Color(galaxyFilamentHSL),a=new THREE.Color(galaxySubset1HSL),l=new THREE.Color(galaxySubset2HSL),i=new THREE.Color(skewerAbsorptionMinHSL),s=new THREE.Color(skewerAbsorptionMaxHSL);guiParams={filMode:!1,galNearSkewer:!1,galDist2Skewer:distanceFromSkewer,galRvirScal:galaxyRvirScalar,galRedHSL:[255*e.r,255*e.g,255*e.b],galBlueHSL:[255*t.r,255*t.g,255*t.b],galaxyFilamentHSL:[255*r.r,255*r.g,255*r.b],galaxySubSelect:!1,galaxySubset1HSL:[255*a.r,255*a.g,255*a.b],galaxySubset2HSL:[255*l.r,255*l.g,255*l.b],skewerAbsorMinHSL:[255*i.r,255*i.g,255*i.b],skewerAbsorMaxHSL:[255*s.r,255*s.g,255*s.b],skewersVisible:function(){cylinderGroup.visible=!cylinderGroup.visible,cylinderBackGroup.visible=!cylinderBackGroup.visible},textVisible:function(){textGroup.visible=!textGroup.visible}};var o=gui.addFolder("Galaxies"),n=o.add(guiParams,"filMode").name("Filament Highlight Mode"),d=o.add(guiParams,"galRvirScal",galaxyRvirScalar/2,10*galaxyRvirScalar).name("Rvir Scalar"),c=o.addColor(guiParams,"galRedHSL").name("Red Value"),p=o.addColor(guiParams,"galBlueHSL").name("Blue Value"),u=o.addColor(guiParams,"galaxyFilamentHSL").name("Filament Value"),g=o.addColor(guiParams,"galaxySubset1HSL").name("Custom Set 1 Value"),x=o.addColor(guiParams,"galaxySubset2HSL").name("Custom Set 2 Value"),h=o.add(guiParams,"galaxySubSelect").name("Show Custom Set"),f=gui.addFolder("Skewers"),y=(f.add(guiParams,"skewersVisible").name("Toggle Skewer Visibility"),f.add(guiParams,"textVisible").name("Toggle Text Visibility"),f.addColor(guiParams,"skewerAbsorMinHSL").name("Minimum Absorption")),m=f.addColor(guiParams,"skewerAbsorMaxHSL").name("Maximum Absorption");d.onChange(function(e){boxOfPoints.material.uniforms.galaxyRvirScalar.value=e}),c.onChange(function(e){boxOfPoints.material.uniforms.redColor.value=new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}),p.onChange(function(e){boxOfPoints.material.uniforms.blueColor.value=new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}),u.onChange(function(e){boxOfPoints.material.uniforms.filamentColor.value=new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}),g.onChange(function(e){boxOfPoints.material.uniforms.group1Color.value=new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}),h.onChange(function(e){e?(loadGalaxySubset1(),loadGalaxySubset2()):hideCustomGalaxies()}),x.onChange(function(e){boxOfPoints.material.uniforms.group2Color.value=new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}),n.onChange(function(e){console.log(e),filMode=e}),y.onChange(function(e){skewerAbsorptionMinHSL="rgb("+Math.round(e[0])+" ,"+Math.round(e[1])+" ,"+Math.round(e[2])+")";for(var t=0,r=cylinderGroup.children.length;t<r;t++)createAbsorptionDataTexture(skewer[t])}),m.onChange(function(e){skewerAbsorptionMaxHSL="rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")";for(var t=0,r=cylinderGroup.children.length;t<r;t++)createAbsorptionDataTexture(skewer[t])}),o.open(),f.open(),gui.close();let v=()=>{controls.enabled=!1,controls.update()},b=()=>{controls.enabled=!0,controls.update()};["dat-gui","details"].forEach(e=>{let t=document.getElementById(e);t.onmouseover=v,t.onmouseout=b});let w=document.getElementsByClassName("close-button");document.getElementById("dat-gui").prepend(w[0])}function onWindowResize(){columnWidth=window.innerWidth/3;var e=document.getElementsByTagName("canvas")[0];e.width=window.innerWidth-columnWidth,e.height=window.innerHeight-200,renderer.setSize(window.innerWidth-columnWidth,window.innerHeight-200),camera.aspect=(window.innerWidth-columnWidth)/(window.innerHeight-200),camera.updateProjectionMatrix();let t=graphs.length;for(w=0;w<t;w++)d3.select("#details").selectAll("#graph"+w).remove();d3.select("#depth-brush").empty(),graphs=createGraph(n_skewers),plotSkewerSpectra(xScale,yScale),plotSkewerSpectra(),EW_plot_init(),EW_plot()}function animate(){target.x=.002*(1-mouse.x),target.y=.002*(1-mouse.y),camera.rotation.x+=.05*(target.y-camera.rotation.x),camera.rotation.y+=.05*(target.x-camera.rotation.y),requestAnimationFrame(animate),controls.update(),renderer.render(scene,camera)}function createAbsorptionDataTexture(e){let t=skewerData.get(e),r=cylinderGroup.children[skewer.indexOf(e)];if(t&&t.HI){let t=skewerData.get(e).HI.map(e=>e.flux_norm);for(var a,l=t.length-1,i=new Uint8Array(4*l),s=new THREE.Color(skewerAbsorptionMinHSL),o=new THREE.Color(skewerAbsorptionMaxHSL),n=s.getHSL(),d=o.getHSL(),c=new THREE.Color(0,0,0),p=0;p<l;p++){var u,g=t[p]-1;g<0?(u=-1*g,c.setHSL(n.h,n.s,u+.2)):c.setHSL(d.h,d.s,u+.2);var x=4*p;i[x]=parseInt(255*c.r),i[x+1]=parseInt(255*c.g),i[x+2]=parseInt(255*c.b),i[x+3]=255}a=skewerLinearFiltering?new THREE.DataTexture(i,1,l,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter):new THREE.DataTexture(i,1,l,THREE.RGBAFormat),a.needsUpdate=!0,r.material.uniforms.texture.value=a}}var z_d=loadLookUp();loadCloseImpactLookUp();var z_left,z_right,z_abs,EW_selected,E_pressed,selectedFilID,renderer,scene,camera,controls,gui,guiParams,EW_coord=[],EW_all=[],ferr=[],reds=[],waves=[],fluxes=[],EW_stat=0,spec_wav=[],spec_flux=[],quasar_galaxy_EW_neighbors=[],neighbors=[],v=[],filMode=!1;const target=new THREE.Vector2;var boxOfPoints,cylinderGroup,cylinderBackGroup,textGroup,galaxyFile,skewerFile,cameraFocalPoint,galaxies=[],skewer=[],skewerData=new Map,tex1=(new THREE.TextureLoader).load("blur.png"),optionFile="options.txt",galaxySubset1=[],galaxySubset2=[],galaxyRvirScalar=1,galaxyRedHSL="hsl(0, 90%, 50%)",galaxyBlueHSL="hsl(200, 70%, 50%)",galaxyFilamentHSL="hsl(150, 100%, 50%)",galaxySubset1HSL="hsl(60, 100%, 50%)",galaxySubset2HSL="hsl(300, 100%, 50%)",skewerAbsorptionMinHSL="hsl(100, 90%, 50%)",skewerAbsorptionMaxHSL="hsl(280, 90%, 60%)",showLabels=!0,boxRadius=30,skewerLinearFiltering=!1,filterDistantGalaxies=!1,distanceFromSkewer=1.5,raycaster=new THREE.Raycaster,mouse=new THREE.Vector2,col_m=new THREE.Vector2,pointOverIdx=-1,prevPointOverIdx=-1,cylOverIdx=-1;let columnWidth=self.innerWidth/3,graphHeight=200,depthDomain=[.017,.029],n_skewers=19;var prevCylOverIdx=[];for(i=0;i<n_skewers;i++)prevCylOverIdx.push(-1);let graphs=createGraph(n_skewers);var currentGalaxy,cyl_0,boxHeight="dist",boxWidth=2,halfWidth=boxWidth,halfSize=10,selectedGalaxies=[],trigger=!1,cyl=[],projections=[],quasar_galaxy_neighbors=[],allLoaded=!1,filterbyIP=!1;let xScale=()=>d3.scaleLinear().domain(depthDomain).range([0,columnWidth-50]),yScale=()=>d3.scaleLinear().domain([0,2]).range([graphHeight,0]);init(),animate();let computeProjections=()=>{skewer.forEach(e=>{let t=skewerData.get(e);Number.prototype.toRad=function(){return this*Math.PI/180};let r=galaxies.map(e=>(distance=haversine(t.DEC,e.DEC,t.RA,e.RA,e.redshift),[distance]));projections.push(r)})};var galaxiesInFilaments=[];