var z_d=loadLookUp();loadCloseImpactLookUp();var EW_coord=[],EW_all=[],z_left,z_right,z_abs,EW_selected,E_pressed,ferr=[],reds=[],waves=[],fluxes=[],EW_stat=0,spec_wav=[],spec_flux=[],quasar_galaxy_EW_neighbors=[],neighbors=[],v=[],renderer,scene,camera,controls,gui,guiParams;const target=new THREE.Vector2;var boxOfPoints,cylinderGroup,cylinderBackGroup,textGroup,galaxies=[],skewer=[],skewerData=new Map,tex1=(new THREE.TextureLoader).load("blur.png"),optionFile="options.txt",galaxyFile,skewerFile,galaxyRvirScalar=1,galaxyRedHSL="hsl(0, 90%, 50%)",galaxyBlueHSL="hsl(200, 70%, 50%)",skewerAbsorptionMinHSL="hsl(100, 90%, 50%)",skewerAbsorptionMaxHSL="hsl(280, 90%, 60%)",showLabels=!0,cameraFocalPoint,boxRadius=30,skewerLinearFiltering=!1,filterDistantGalaxies=!1,distanceFromSkewer=1.5,raycaster=new THREE.Raycaster,mouse=new THREE.Vector2,col_m=new THREE.Vector2,pointOverIdx=-1,prevPointOverIdx=-1,cylOverIdx=-1;let columnWidth=self.innerWidth/3,graphHeight=200,depthDomain=[.017,.029],n_skewers=19;var prevCylOverIdx=[];for(i=0;i<n_skewers;i++)prevCylOverIdx.push(-1);let graphs=createGraph(n_skewers);var boxHeight="dist",boxWidth=2,halfWidth=boxWidth,halfSize=10,currentGalaxy,selectedGalaxies=[],trigger=!1,cyl=[],cyl_0,projections=[],quasar_galaxy_neighbors=[],allLoaded=!1,filterbyIP=!1;let xScale=()=>d3.scaleLinear().domain(depthDomain).range([0,columnWidth-50]),yScale=()=>d3.scaleLinear().domain([0,2]).range([graphHeight,0]);function updateDepthDomain(min,max){null!=min&&(depthDomain[0]=min),null!=max&&(depthDomain[1]=max),xScale=(()=>d3.scaleLinear().domain(depthDomain).range([0,columnWidth-50]))}function loadGalaxyData(callback){d3.json("data/galaxies_bigger.json").then(function(d){processGalaxyData(galaxies=d),callback()})}function loadProjections(){d3.json(projectionData).then(function(d){projections=d})}function loadP(idxP){-1!=idxP&&d3.json("data/projections/p"+idxP+".json").then(function(d){projections[idxP]=d,plotSkewerNeighbors()})}function loadLookUp(){d3.json("data/projections/lookUp.json").then(function(d){z_d=d})}function lookUp(redshift){let found=z_d.find(function(element){return element.z===redshift});return found?found.d:cosmcalc(redshift)}function loadCloseImpactLookUp(){d3.dsv(" ","data/galaxyCloseImpactLookup_bigger.dat").then(function(d){impactParameters=d})}function cosmcalc(redshift){let z;var H0=73,WM=.27,WV=.73;let verbose=0,WR=0,WK=0,c=299792.458,Tyr=977.8,DTT=.5,DTT_Gyr=0,age=.5,age_Gyr=0,zage=.1,zage_Gyr=0,DCMR=0,DCMR_Mpc=0,DCMR_Gyr=0,DA=0,DA_Mpc=0,DA_Gyr=0,kpc_DA=0,DL=0,DL_Mpc=0,DL_Gyr=0,V_Gpc=0,a=1,az=.5,h=.73;for(WK=.73-(WR=4165e-8/(h*h))-WV,az=1/(1+1*redshift),age=0,n=1e3,i=0;i<n;i++){let adot;a=az*(i+.5)/n,age+=1/Math.sqrt(WK+WM/a+WR/(a*a)+WV*a*a)}for(zage_Gyr=Tyr/73*(zage=az*age/n),DTT=0,DCMR=0,i=0;i<n;i++){a=az+(1-az)*(i+.5)/n;let adot=Math.sqrt(WK+WM/a+WR/(a*a)+WV*a*a);DTT+=1/adot,DCMR+=1/(a*adot)}age_Gyr=(age=(DTT=(1-az)*DTT/n)+zage)*(Tyr/73),DTT_Gyr=Tyr/73*DTT,DCMR_Gyr=Tyr/73*(DCMR=(1-az)*DCMR/n),DCMR_Mpc=c/73*DCMR;let ratio=1,x=Math.sqrt(Math.abs(WK))*DCMR;if(x>.1?ratio=sin(x)/x:(y=x*x,y=-y,ratio=1+y/6+y*y/120),DCMT=ratio*DCMR,kpc_DA=(DA_Mpc=c/73*(DA=az*DCMT))/206.264806,DA_Gyr=Tyr/73*DA,DL_Mpc=c/73*(DL=DA/(az*az)),DL_Gyr=Tyr/73*DL,ratio=1,(x=Math.sqrt(Math.abs(WK))*DCMR)>.1)ratio=(x/2-sin(2*x)/4)/(x*x*x/3);else{let y=x*x;ratio=1+(y=-y)/5+2/105*y*y}return VCM=ratio*DCMR*DCMR*DCMR/3,V_Gpc=4*Math.pi*4.106746**3*VCM,DA_Mpc}function roundtothree(s,round=!0){let v=parseFloat(s);return round?Math.round(1e3*v)/1e3:v}function roundtofive(s,round=!0){let v=parseFloat(s);return round?Math.round(1e5*v)/1e5:v}function loadSkewerData(callback){d3.dsv(" ",skewerFile,d=>({name:d.name,RA:+d.RA,DEC:+d.DEC})).then(data=>{data.forEach(d=>{skewer.push(d.name),plotSkewer(d.name,d.RA,d.DEC);let file=[d.name]+".dat",spectra=["HI","CIV"];skewerData.set(d.name,{RA:+d.RA,DEC:+d.DEC,startPoint:sphericalToCartesian(d.RA,d.DEC,galaxy_redshift_min).clone(),endPoint:sphericalToCartesian(d.RA,d.DEC,galaxy_redshift_max).clone()}),spectra.forEach(el=>{let path="data/spectra_"+el+"_norm_bigger/";d3.dsv(" ",path+file,d=>({sig_norm:parseFloat(d.sig_norm),flux_norm:parseFloat(d.flux_norm),redshift:parseFloat(d.redshift),wavelength:parseFloat(d.wavelength)})).then(data=>{data.length>1&&(skewerData.get(d.name)[el]=data,skewer_redshift_min=skewerData.get(d.name)[el][0].redshift,skewer_redshift_min<depthDomain[0]&&null!=skewer_redshift_min&&(updateDepthDomain(skewer_redshift_min,void 0),createBrush(),createSlider()),skewer_redshift_max=skewerData.get(d.name)[el][skewerData.get(d.name)[el].length-1].redshift,skewer_redshift_max>depthDomain[1]&&null!=skewer_redshift_max&&(updateDepthDomain(void 0,skewer_redshift_max),createBrush(),createSlider()),"HI"===el&&createAbsorptionDataTexture(d.name))})})}),callback()})}init(),animate();let computeProjections=()=>{skewer.forEach(k=>{let u=skewerData.get(k);Number.prototype.toRad=function(){return this*Math.PI/180};let ret=galaxies.map(v=>(distance=haversine(u.DEC,v.DEC,u.RA,v.RA,v.redshift),[distance]));projections.push(ret)})};function haversine(dec1,dec2,ra1,ra2,redshift){let z=lookUp(redshift),lat1=dec1.toRad(),lat2=dec2.toRad(),dLat=(dec2-dec1).toRad(),dLon=(ra2-ra1).toRad(),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2),c,distance;return roundtothree(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*z)}function exportData(name,text){const a=document.createElement("a"),type=name.split(".").pop();a.href=URL.createObjectURL(new Blob([text],{type:`text/${"txt"===type?"plain":type}`})),a.download=name,a.click()}function getQuasarGalaxyNeighbors(){let i=prevCylOverIdx,n=graphs.length;for(w=0;w<n;w++)if(-1!=i[w]){let k=skewer[i[w]],p=projections[i[w]];if(quasar_galaxy_neighbors[w]=[],quasar_galaxy_neighbors[w].push(skewerData.get(k)),p)for(let j=0;j<galaxies.length;++j){let dist=p[j],u=galaxies[j];dist<distanceFromSkewer&&quasar_galaxy_neighbors[w].push(u)}}}function veltrans(redshift,waves,line){let c=299792.458,transline=[],z_1=math.add(redshift,1),z_1l=math.multiply(z_1,line),w_z_1l=math.subtract(waves,z_1l),c_w=math.multiply(c,w_z_1l),c_w_l=math.divide(c_w,line);if(line.length)for(ll=0;ll<line.length;ll++)transline.push(c*(waves[ll]-(1+redshift[ll])*ll)/ll/(1+redshift[ll]));else transline=math.divide(c_w_l,z_1);return transline}function EW_ACD_array(wave,flux,ferr,zabs,vellim=[-50,50],cont="None",restlam=1215.67,fosc=.4164){let c=299792.458;if("None"==cont)for(cont=[],i=0;i<wave.length;i++)cont.push(1);let vel=veltrans(zabs,wave,restlam),velidx=[];for(v[0]=wave[0],v[1]=wave[wave.length-1],vellim=veltrans(zabs,v,restlam),i=0;i<vel.length;i++)vel[i]>=vellim[0]&&vel[i]<=vellim[1]&&velidx.push(i);let velup=vel[velidx[1]],veldown=vel[velidx[0]],dv=Math.abs(velup-veldown),effflux=flux;for(i=0;i<flux.length;i++)flux[i]<ferr[i]?(belowerr=i,i=flux.length):belowerr=-1;effflux[belowerr]=ferr[belowerr];let EWpix=[],sigEWf=[],tauv=[],tauverr_f=[],Npix,sigNf;for(i=0;i<velidx.length;i++){let l=dv*(1-effflux[velidx[i]]/cont[velidx[i]])*restlam/c,m=dv/cont[velidx[i]]*ferr[velidx[i]]*restlam/c,n=math.log(cont[velidx[i]]/effflux[velidx[i]]),o=ferr[velidx[i]]/effflux[velidx[i]];EWpix.push(l),sigEWf.push(m),tauv.push(n),tauverr_f.push(o)}return[EWpix,sigEWf,math.multiply(1/2.654e-15/restlam/fosc*dv,tauv),math.multiply(1/2.654e-15/restlam/fosc*dv,tauverr_f)]}function EW_ACD(wave,flux,ferr,zabs,vellim=[-50,50],cont="None",restlam=1215.67,fosc=.4164){if("None"==cont)for(cont=[],i=0;i<wave.length;i++)cont.push(1);let EWarray=EW_ACD_array(wave,flux,ferr,zabs,vellim,cont,restlam,fosc),EWpix=EWarray[0],sigEWf=EWarray[1],Npix=EWarray[2],sigNf=EWarray[3],EW=math.sum(EWpix),N=math.sum(Npix),k=0;for(i=0;i<sigEWf.length;i++)k+=math.pow(sigEWf[i],2);let sigEWf_tot=math.sqrt(k),sigNf_tot;for(k=0,i=0;i<sigNf.length;i++)k+=math.pow(sigNf[i],2);return[EW,sigEWf_tot,N,math.sqrt(k)]}function pressLeft(){z_left=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('left boundary ✓, press "E"')}function pressRight(){z_right=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('right boundary ✓, press "E"')}function selectZ(){z_abs=EW_coord[0],d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("center point selected"),getSkewerSpectra(),d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove()}function getSkewerSpectra(){let k=EW_selected[1];for(waves=[],fluxes=[],i=0;i<k.length;i++)if("HI"==k[i].key){let k_spec=k[i].value;for(j=0;j<k_spec.length;j++)reds[j]=k_spec[j].redshift;var leftIdx=reds.indexOf(z_left),rightIdx=reds.indexOf(z_right);if(-1==rightIdx){goal=z_right;var closestR=reds.reduce(function(prev,curr){return Math.abs(curr-goal)<Math.abs(prev-goal)?curr:prev});rightIdx=reds.indexOf(closestR)}if(-1==leftIdx){goal=z_left;var closestL=reds.reduce(function(prev,curr){return Math.abs(curr-goal)<Math.abs(prev-goal)?curr:prev});leftIdx=reds.indexOf(closestL)}for(w=leftIdx;w<rightIdx;w++)waves.push(k_spec[w].wavelength),fluxes.push(k_spec[w].flux_norm),ferr.push(k_spec[w].sig_norm)}let EW_out=EW_ACD(waves,fluxes,ferr,z_abs,vellim=[-50,50],cont="None",restlam=1215.67,fosc=.4164);EW_all.push([EW_selected[0],EW_out[0],reds[leftIdx],reds[rightIdx],EW_out[1]]),EW_plot()}function EW_plot_init(){let ret;d3.select("#bottom-panel").selectAll("#EW-plot").select("#EWplot").remove(),d3.select("#bottom-panel").selectAll("#EW-plot").append("svg").attr("id","EWplot").attr("width",208).attr("height",200).style("fill","#1d1d1d").append("rect").attr("x",0).attr("y",0).attr("width",208).attr("height",200).attr("fill","#1d1d1d"),0==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text('Press "E" to start')),EW_plot()}function EW_plot(){for(neighbors=[],i=0;i<EW_all.length;i++){let fnew=filterNeighborsEW(EW_all[i][1],EW_all[i][2],EW_all[i][3],EW_all[i][0],EW_all[i][4]);fnew&&neighbors.push(fnew)}d3.select("body").select("#bottom-panel").select("#EW-plot").select("#EWplot").selectAll("g").remove();var xScale=d3.scaleLinear().domain([0,distanceFromSkewer]).range([0,150]),yScale=d3.scaleLinear().domain([1.2,0]).range([0,130]),svg=d3.select("body").select("#bottom-panel").select("#EW-plot").select("#EWplot").append("svg").append("g").attr("transform","translate(45,180)"),tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),xAxis=d3.axisBottom().scale(xScale).ticks(6),yAxis=d3.axisLeft().scale(yScale).ticks(5);svg.append("g").attr("class","xAxis").attr("transform","translate(0,-20)").call(xAxis),svg.append("text").text("Impact Parameter (Mpc)").style("fill","white").attr("font-size","11px").attr("transform","translate(8,12)"),svg.append("g").attr("class","yAxis").call(yAxis).attr("transform","translate(0,-150)"),svg.append("text").text("Equivalent Width (Å)").attr("transform","rotate(-90)").attr("y",-30).attr("x",35).style("fill","white").attr("font-size","11px"),svg.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-line").attr("x1",function(d){return xScale(d.ip)}).attr("y1",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew-.1)-150}return yScale(d.ew+d.sigEWf)-150}).attr("x2",function(d){return xScale(d.ip)}).attr("y2",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew)-150}return yScale(d.ew-d.sigEWf)-150}).attr("stroke",function(d){return"blue"==d.color?"#00aeff":"#ff0000"}),svg.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(d){if(!(d.ew<3*d.sigEWf))return xScale(d.ip)-4}).attr("y1",function(d){if(!(d.ew<3*d.sigEWf))return yScale(d.ew+d.sigEWf)-150}).attr("x2",function(d){if(!(d.ew<3*d.sigEWf))return xScale(d.ip)+4}).attr("y2",function(d){if(!(d.ew<3*d.sigEWf))return yScale(d.ew+d.sigEWf)-150}).attr("stroke",function(d){return"blue"==d.color?"#00aeff":"#ff0000"}),svg.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(d){return xScale(d.ip)-4}).attr("y1",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew-.1)-154}return yScale(d.ew-d.sigEWf)-150}).attr("x2",function(d){return d.ew<3*d.sigEWf?xScale(d.ip):xScale(d.ip)+4}).attr("y2",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew-.1)-150}return yScale(d.ew-d.sigEWf)-150}).attr("stroke",function(d){return"blue"==d.color?"#00aeff":"#ff0000"}),svg.append("g").selectAll("line").data(neighbors).enter().append("line").attr("class","error-cap").attr("x1",function(d){if(d.ew<3*d.sigEWf)return xScale(d.ip)}).attr("y1",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew-.1)-150}}).attr("x2",function(d){if(d.ew<3*d.sigEWf)return xScale(d.ip)+4}).attr("y2",function(d){if(d.ew<3*d.sigEWf){let ew=3*d.sigEWf;return yScale(ew-.1)-154}}).attr("stroke",function(d){return"blue"==d.color?"#00aeff":"#ff0000"}),svg.selectAll(".dot").data(neighbors).enter().append("circle").attr("class","dot").attr("r",2).attr("cx",function(d){return xScale(d.ip)}).attr("cy",function(d){return d.ew<3*d.sigEWf?yScale(3*d.sigEWf)-150:yScale(d.ew)-150}).attr("fill",function(d){return"blue"==d.color?"#00aeff":"#ff0000"}).on("mouseover",function(d){tooltip.transition().duration(200).style("opacity",.75),tooltip.html("QSO: "+d.skewer+"<br/> NSAID: "+d.NSAID+"<br/> IP: "+d.ip+" Mpc <br/> EW: "+roundtofive(d.ew)+" Å <br/> zmin: "+d.zmin+"<br/> zmax: "+d.zmax+"<br/> zabs: "+d.zabs+"<br/> velmin: "+d.velmin+" km/s <br/> velmax: "+d.velmax+"km/s").style("left",d3.event.pageX-25+"px").style("top",d3.event.pageY-170+"px");var g=galaxies[d.gidx];currentGalaxy=[g,d.gidx],plotGalaxyImage(d.gidx),plotSkewerNeighbors()}).on("mouseout",function(d){tooltip.transition().duration(200).style("opacity",0)})}function filterNeighborsEW(EW,z_min,z_max,skewerName,err){let mn=z_min,mx=z_max,i=skewer.indexOf(skewerName),x;if(quasar_galaxy_EW_neighbors=[],-1!=i){let k=skewer[i],p=projections[i];if(p)for(let j=0;j<galaxies.length;++j){let dist=p[j],u=galaxies[j];if(dist<distanceFromSkewer&&mn<u.redshift&&mx>u.redshift){var qgew={skewer:skewerName,NSAID:u.NSAID,zmin:z_min,zmax:z_max,ip:+dist[0],ew:EW,zabs:z_abs,velmin:v[0],velmax:v[1],gidx:j,color:u.color,sigEWf:err};quasar_galaxy_EW_neighbors.includes(qgew)||quasar_galaxy_EW_neighbors.push(qgew)}}}return(x=quasar_galaxy_EW_neighbors.sort(function(a,b){return a.ip-b.ip}))[0]}function mapKeyPressToActualCharacter(isShiftKey,characterCode){return"boolean"==typeof isShiftKey&&"number"==typeof characterCode&&(isShiftKey?characterMapShift[characterCode]:characterMap[characterCode])}function onKeyDown(event){var keyChar=String.fromCharCode(event.keyCode),shiftKeyPressed=KeyboardEvent.shiftKey;"E"==keyChar&&(E_pressed=!0,0==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select left boundary")),1==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select right boundary")),2==EW_stat&&(d3.select("body").select("#EW-plot").select("#EWplot").select(".EW-status").remove(),d3.select("body").select("#EW-plot").select("#EWplot").append("text").attr("class","EW-status").text("select center point"))),"G"==keyChar?selectedGalaxies.includes(currentGalaxy[1])||(d3.select("#bottom-panel").selectAll("#imageSaveInstructions").remove(),selectedGalaxies.push(currentGalaxy[1]),trigger=!0,plotGalaxyImage(currentGalaxy[1],trigger),trigger=!1):"N"==keyChar?loadAllP(toggleGalaxiesNearSkewers):"S"==keyChar?(cylinderGroup.visible=!cylinderGroup.visible,cylinderBackGroup.visible=!cylinderBackGroup.visible):"T"==keyChar?textGroup.visible=!textGroup.visible:"Z"==keyChar&&zoomToGalaxy(),"1"!=keyChar||event.shiftKey?"2"!=keyChar||event.shiftKey?"3"!=keyChar||event.shiftKey?"4"!=keyChar||event.shiftKey?"5"!=keyChar||event.shiftKey?"6"!=keyChar||event.shiftKey?"7"!=keyChar||event.shiftKey?"8"!=keyChar||event.shiftKey?"9"!=keyChar||event.shiftKey?"1"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[10]?prevCylOverIdx[10]=prevCylOverIdx[0]:(prevCylOverIdx[10]=-1,unselectSkewer()),plotSkewerSpectra()):"2"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[11]?prevCylOverIdx[11]=prevCylOverIdx[0]:(prevCylOverIdx[11]=-1,unselectSkewer()),plotSkewerSpectra()):"3"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[12]?prevCylOverIdx[12]=prevCylOverIdx[0]:(prevCylOverIdx[12]=-1,unselectSkewer()),plotSkewerSpectra()):"4"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[13]?prevCylOverIdx[13]=prevCylOverIdx[0]:(prevCylOverIdx[13]=-1,unselectSkewer()),plotSkewerSpectra()):"5"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[14]?prevCylOverIdx[14]=prevCylOverIdx[0]:(prevCylOverIdx[14]=-1,unselectSkewer()),plotSkewerSpectra()):"6"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[15]?prevCylOverIdx[15]=prevCylOverIdx[0]:(prevCylOverIdx[15]=-1,unselectSkewer()),plotSkewerSpectra()):"7"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[16]?prevCylOverIdx[16]=prevCylOverIdx[0]:(prevCylOverIdx[16]=-1,unselectSkewer()),plotSkewerSpectra()):"8"==keyChar&&event.shiftKey?(-1==prevCylOverIdx[17]?prevCylOverIdx[17]=prevCylOverIdx[0]:(prevCylOverIdx[17]=-1,unselectSkewer()),plotSkewerSpectra()):"9"==keyChar&&event.shiftKey&&(-1==prevCylOverIdx[18]?prevCylOverIdx[18]=prevCylOverIdx[0]:(prevCylOverIdx[18]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[9]?prevCylOverIdx[9]=prevCylOverIdx[0]:(prevCylOverIdx[9]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[8]?prevCylOverIdx[8]=prevCylOverIdx[0]:(prevCylOverIdx[8]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[7]?prevCylOverIdx[7]=prevCylOverIdx[0]:(prevCylOverIdx[7]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[6]?prevCylOverIdx[6]=prevCylOverIdx[0]:(prevCylOverIdx[6]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[5]?prevCylOverIdx[5]=prevCylOverIdx[0]:(prevCylOverIdx[5]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[4]?prevCylOverIdx[4]=prevCylOverIdx[0]:(prevCylOverIdx[4]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[3]?prevCylOverIdx[3]=prevCylOverIdx[0]:(prevCylOverIdx[3]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[2]?prevCylOverIdx[2]=prevCylOverIdx[0]:(prevCylOverIdx[2]=-1,unselectSkewer()),plotSkewerSpectra()):(-1==prevCylOverIdx[1]?prevCylOverIdx[1]=prevCylOverIdx[0]:(prevCylOverIdx[1]=-1,unselectSkewer()),plotSkewerSpectra())}function selectPoint(){for(var cs=boxOfPoints.geometry.attributes.isSelected.array,p=0;p<cs.length;p++)cs[p]=0;cs[pointOverIdx]=1,prevPointOverIdx=pointOverIdx,boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0,plotGalaxyImage(pointOverIdx)}function unselectPoint(){for(var cs=boxOfPoints.geometry.attributes.isSelected.array,p=0;p<cs.length;p++)cs[p]=0;prevPointOverIdx=-1,boxOfPoints.geometry.attributes.isSelected.needsUpdate=!0}function selectSkewer(){for(-1!=cylOverIdx?((cyl_0=cylinderGroup.children[cylOverIdx]).geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0):-1!=prevCylOverIdx[0]&&((cyl_0=cylinderGroup.children[prevCylOverIdx[0]]).geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0),i=1;i<prevCylOverIdx.length;i++)-1!=prevCylOverIdx[i]&&(cyl[i]=cylinderGroup.children[prevCylOverIdx[i]],cyl[i].geometry.attributes.isSelected.set(Array(192).fill(1)),cyl[i].geometry.attributes.isSelected.needsUpdate=!0)}function unselectSkewer(){for(i=1;i<prevCylOverIdx.length;i++)cyl[i]&&-1==prevCylOverIdx[i]&&(cyl[i].geometry.attributes.isSelected.set(Array(192).fill(0)),cyl[i].geometry.attributes.isSelected.needsUpdate=!0);cyl_0&&(cyl_0.geometry.attributes.isSelected.set(Array(192).fill(0)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0),-1!=cylOverIdx&&((cyl_0=cylinderGroup.children[cylOverIdx]).geometry.attributes.isSelected.set(Array(192).fill(1)),cyl_0.geometry.attributes.isSelected.needsUpdate=!0)}function onMouseMove(event){let x=event.clientX,y=event.clientY;if(mouse.x=x/(window.innerWidth-columnWidth)*2-1,mouse.y=-y/(window.innerHeight-200)*2+1,raycaster.setFromCamera(mouse,camera),mouse.y>-1&&mouse.x<1){var intersects=raycaster.intersectObjects(scene.children);pointOverIdx=-1;for(var i=0;i<intersects.length;i++){var p;if("Points"==(p=intersects[i]).object.type&&p.distanceToRay<.4){pointOverIdx=p.index;break}}pointOverIdx>=0&&pointOverIdx!=prevPointOverIdx&&(selectPoint(),plotSkewerSpectra(),plotGalaxyImage(pointOverIdx)),pointOverIdx<0&&prevPointOverIdx>=0&&unselectPoint(),intersects=raycaster.intersectObjects(cylinderGroup.children),-1!=cylOverIdx&&(prevCylOverIdx[0]=cylOverIdx,plotSkewerSpectra()),cylOverIdx=-1;for(var i=0;i<intersects.length;i++){var p=intersects[i];1==cylinderGroup.visible&&"Mesh"==p.object.type&&(cylOverIdx=cylinderGroup.children.indexOf(p.object))}cylOverIdx>-1&&!prevCylOverIdx.includes(cylOverIdx)&&(unselectSkewer(),selectSkewer(),plotSkewerSpectra())}}function createGraph(n_skewers){let graphWidth=columnWidth-50,n=n_skewers;var graphs=[];for(i=0;i<n;i++){let ret=d3.select("#details").select("#graphs").append("div").attr("id","graph"+i).append("svg").attr("width",graphWidth+50).attr("height",graphHeight+50).append("g").attr("transform","translate(25, 25)");ret.append("rect").attr("class","graph-background").attr("x",0).attr("y",0).attr("width",graphWidth).attr("height",graphHeight),i>0&&(ret.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(i),ret.append("text").attr("class","skewerSaveInstructions").attr("x",columnWidth/4).attr("y",100).text("Press "+i+" to save selected skewer")),graphs[i]=ret}return graphs}function plotSkewerSpectra(){i=prevCylOverIdx;let n=graphs.length;for(w=0;w<n;w++){projections[i[w]]||loadP(i[w]);let graph=graphs[w],k=skewer[i[w]],spectra=d3.entries(skewerData.get(k)),x=xScale(),y=yScale();if(-1==i[w]&&(graph.selectAll("graph"+w+"_border").remove(),d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".xaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".title").remove(),d3.select("#details").select("#graph"+w).selectAll("#border").remove(),graph.selectAll(".penHI").remove(),graph.selectAll(".penCIV").remove(),graph.selectAll(".mark").remove(),graph.selectAll(".graphNumber").remove(),graph.selectAll(".skewerSaveInstructions").remove(),w>0&&(graph.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(w),graph.append("text").attr("class","skewerSaveInstructions").attr("x",columnWidth/4).attr("y",100).text("Press "+w+" to save selected skewer"))),-1!=i[w]){let skewIdx=i[w];if(-1!=pointOverIdx){let j,u=galaxies[pointOverIdx]}graph.selectAll("graph"+w+"_border").remove(),d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".xaxis").remove(),d3.select("#details").select("#graph"+w).selectAll(".title").remove(),d3.select("#details").select("#graph"+w).selectAll("#border").remove(),graph.selectAll(".graphNumber").remove(),graph.selectAll(".skewerSaveInstructions").remove(),graph.selectAll(".penHI").remove(),graph.selectAll(".penCIV").remove(),graph.selectAll(".skewerSaveInstructions").remove();let pen=d3.line().x(d=>x(d.redshift)).y(d=>y(d.flux_norm));spectra.forEach(u=>{if(graph.selectAll(".pen"+u.key).remove(),graph.selectAll(".pen"+u.key+"invis").remove(),graph.selectAll("#border").remove(),"HI"==u.key||"CIV"==u.key)var path=graph.append("path").attr("class","pen"+u.key).datum(u.value).attr("d",pen).attr("fill","none"),path=graph.append("path").attr("class","pen"+u.key+"invis").datum(u.value).attr("d",pen).attr("fill","none").on("click",function(){var x0=x.invert(d3.mouse(this)[0]),y0=y.invert(d3.mouse(this)[1]);EW_coord=[roundtofive(x0),roundtofive(y0)],E_pressed&&"HI"==u.key&&(EW_selected=[skewer[skewIdx],spectra],0==EW_stat?(pressLeft(),EW_stat=1,E_pressed=!1):1==EW_stat?(pressRight(),EW_stat=2,E_pressed=!1):2==EW_stat&&(EW_stat=0,E_pressed=!1,selectZ()))});graph.append("rect").attr("id","border").attr("transform","translate(-40,-20)").attr("width",columnWidth+20).attr("height",graphHeight+50),w>0&&graph.append("text").attr("class","graphNumber").attr("x",-15).attr("y",0).text(w);let k=spectra.length-4;1!=k||"HI"!=u.key&&"CIV"!=u.key?2==k&&(d3.select("#details").select("#graph"+w).selectAll("g").selectAll(".yaxis").remove(),graph.selectAll(".penHI").attr("transform","translate(0,"+graphHeight/8+")"),graph.selectAll(".penHIinvis").attr("transform","translate(0,"+graphHeight/8+")"),graph.selectAll(".penCIV").attr("transform","translate(0,"+-1*graphHeight/3+")"),graph.selectAll(".penCIVinvis").attr("transform","translate(0,"+-1*graphHeight/3+")"),graph.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+3*graphHeight/4+") rotate(-90)").style("text-anchor","middle").text("HI"),graph.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+graphHeight/4+") rotate(-90)").style("text-anchor","middle").text("CIV")):graph.append("g").attr("class","yaxis").attr("stroke","white").append("text").attr("transform","translate(-10,"+graphHeight/2+") rotate(-90)").style("text-anchor","middle").text(u.key),d3.selectAll("text").attr("stroke","none").attr("fill","white")})}graph.append("g").attr("class","xaxis").attr("transform","translate(0,"+graphHeight+")").attr("stroke","white").call(d3.axisBottom(x).ticks(6)).selectAll("text").attr("stroke","none").attr("fill","white"),graph.append("text").attr("class","title").attr("transform","translate("+(columnWidth-50)/2+", -7)").attr("text-anchor","middle").attr("fill","white").text(k)}unselectSkewer(),selectSkewer(),plotSkewerNeighbors()}function plotSkewerNeighbors(){let i=prevCylOverIdx,n=graphs.length;for(d3.select("#box-height").on("change",function(a){boxHeight=d3.select(this).property("value"),plotSkewerNeighbors()}),d3.select("#box-width").on("change",function(a){boxWidth=d3.select(this).property("value"),plotSkewerNeighbors()}),w=0;w<n;w++){let graph=graphs[w];if(-1!=i[w]){let k=skewer[i[w]],p=projections[i[w]];if(graph.selectAll(".mark").remove(),p)for(let j=0;j<galaxies.length;++j){let dist=p[j],u=galaxies[j];if(dist<distanceFromSkewer){let distAlong=u.redshift;"dist"==boxWidth?halfWidth=10/dist:"rvir"==boxWidth?halfWidth=10*u.rvir:"sfr"==boxWidth?halfWidth=10*u.sfr:"mstars"==boxWidth?halfWidth=2*u.mstars:"onePx"==boxWidth&&(halfWidth=2),"dist"==boxHeight?halfSize=10/dist:"rvir"==boxHeight?halfSize=10*u.rvir:"sfr"==boxHeight?halfSize=10*u.sfr:"mstars"==boxHeight&&(halfSize=2*u.mstars),graph.append("rect").attr("class","mark g"+j).attr("x",xScale()(distAlong)-halfWidth/2).attr("y",graphHeight/2-halfSize).attr("width",halfWidth).attr("height",2*halfSize).attr("opacity",.85).datum(j).style("fill",j=>currentGalaxy[1]&&currentGalaxy[1]==j?"#00ff00":selectedGalaxies.includes(j)?"blue"==galaxies[j].color?"#00aeff":"#ff0000":void 0).on("mouseover",j=>{pointOverIdx=j,selectPoint(),plotGalaxyImage(pointOverIdx),plotSkewerSpectra()}).on("mouseout",j=>{prevPointOverIdx=j,unselectPoint()})}}}}}function plotGalaxyImage(idx){let j=idx;var g=galaxies[idx];currentGalaxy=[g,idx];let f=roundtothree,lines=["NSAID: "+g.NSAID,"DEC = "+g.DEC,"RA = "+g.RA,"mstars = "+g.mstars,"sfr = "+g.sfr,"sfr_err = "+g.sfr_err,"redshift: "+g.redshift,"rvir: "+g.rvir,"log_sSFR: "+g.log_sSFR];if(trigger){var txt=d3.select("#selectedGalaxies").append("div").attr("id","galaxyDesc"+g.NSAID).attr("class","galaxyQueue galaxyQueue-Desc"),svg;(svg=d3.select("#selectedGalaxies").append("div").attr("id","galaxyImage"+g.NSAID).attr("class","galaxyQueue")).append("img").attr("src","data/galaxyImages/"+g.NSAID+".jpg").attr("height","160px").attr("padding","10px").on("mouseover",j=>{pointOverIdx=j,selectPoint()}).on("mouseout",j=>{prevPointOverIdx=j,unselectPoint()}),txt.selectAll("p").data(lines).enter().append("p").style("width","150px").text(d=>d),svg.selectAll("img").on("mouseover",j=>{pointOverIdx=idx;let m=galaxies[idx];currentGalaxy=[m,idx],plotSkewerNeighbors(),selectPoint()}).on("mouseout",j=>{prevPointOverIdx=idx,unselectPoint()}),$("div#selectedGalaxies").animate({scrollLeft:"0"},400)}else{var txt=d3.select("#galaxyDesc"),svg=d3.select("#galaxyImage"),galaxyDesc,galaxyImage;txt.select("div").remove(),svg.select("div").remove(),txt.append("div").selectAll("p").data(lines).enter().append("p").text(d=>d),svg.append("div").append("img").attr("src","data/galaxyImages/"+g.NSAID+".jpg").attr("width","160px").on("mouseover",j=>{pointOverIdx=idx,selectPoint(),plotSkewerNeighbors()}).on("mouseout",j=>{prevPointOverIdx=idx,unselectPoint()})}}function createSlider(init=distanceFromSkewer){let width=columnWidth-columnWidth/4,pad=20;d3.select("#details").selectAll("#neighbor-slider").remove();let svg=d3.select("#details").append("div").attr("id","neighbor-slider").append("svg");svg.attr("width",width+80).attr("height",30),svg.append("rect").attr("class","slider-track").attr("x",20).attr("y",12.5).attr("width",width-40).attr("height",5).style("fill","gray");let scale=d3.scaleLinear().range([20,width-20]).domain([0,10]).clamp(!0);svg.append("text").attr("id","slider-value").attr("x",width).attr("y",17.5).text(init+" Mpc").style("fill","white");let drag=d3.drag().on("drag",function(){if(0===d3.event.dx)return;let x=d3.event.x;x=x<20?20:x>width-20?width-20:x,d3.select(this).attr("cx",x);let value=scale.copy().invert(x);svg.select("#slider-value").text(roundtothree(value)+" Mpc"),distanceFromSkewer=value,filterDistantGalaxies&&filterGalaxiesNearSkewers(),plotSkewerNeighbors(),EW_plot()});svg.append("g").append("circle").attr("class","slider-handle").attr("cx",scale(init)).attr("cy",15).attr("r",10).style("fill","white").style("stroke","gray").style("stroke-width",2.5).call(drag).on("dblclick",()=>{loadAllP(toggleGalaxiesNearSkewers),svg.select(".slider-handle").style("fill",()=>filterDistantGalaxies?"black":"white")})}function createBrush(){d3.select("#details").selectAll("#depth-brush").remove();let svg=d3.select("#details").append("div").attr("id","depth-brush").append("svg"),margin={top:5,left:20,bottom:20,right:20},axis=svg.append("g"),brush=svg.append("g").attr("class","brush"),width=0,height=0,x=d3.scaleLinear().domain(depthDomain).range([margin.left,width-1]);function resize(){var w=columnWidth-margin.right,h=60,aspect,vw=columnWidth,vh=vw/(w/h);width=vw,height=vh-margin.bottom,svg.attr("width",w).attr("height",h).attr("viewBox","0 0 "+vw+" "+vh),x.range([margin.left,width-margin.right]),axis.attr("transform","translate(0,"+height+")").call(d3.axisBottom(x).ticks(6))}function drawBrush(){if(!x)return;let brusher=d3.brushX().extent([[margin.left,0],[width-margin.right,height]]).on("brush end",brushed);brush.call(brusher).call(brusher.move,x.range())}function brushed(){var s=d3.event.selection||x.range();ret=s.map(x.invert,x),ret[0]!==ret[1]&&(updateDepthDomain(ret[0],ret[1]),-1!==prevCylOverIdx[0]&&-1!==prevCylOverIdx[0]&&(plotSkewerSpectra(),plotSkewerNeighbors()),filterBrushedGalaxies())}resize(),drawBrush()}function processOptions(callback){let parse={skewerData:v=>{skewerFile=v},galaxyData:v=>{galaxyFile=v},projectionData:v=>{projectionData=v},lookUpTable:v=>{lookUpTable=v},galaxyRvirScalar:v=>{galaxyRvirScalar=parseFloat(v)},galaxyRedHSL:v=>{galaxyRedHSL=v},galaxyBlueHSL:v=>{galaxyBlueHSL=v},skewerWidth:v=>{skewerWidth=parseFloat(v)},skewerAbsorptionMinHSL:v=>{skewerAbsorptionMinHSL=v},skewerAbsorptionMaxHSL:v=>{skewerAbsorptionMaxHSL=v},skewerLinearFiltering:v=>{skewerLinearFiltering="true"==v},boxRadius:v=>{boxRadius=v},cameraFocalPoint:v=>{var vals=v.split(",");cameraFocalPoint=new THREE.Vector3(parseFloat(vals[0]),parseFloat(vals[1]),parseFloat(vals[2])),controls.enableZoom=!1,controls.target=cameraFocalPoint,controls.update()},cameraPositionX:v=>{camera.position.x=v},cameraPositionY:v=>{camera.position.y=v},cameraPositionZ:v=>{camera.position.z=v}};d3.text("options.txt").then(data=>{let rows=data.split("\n");for(var i=0;i<rows.length;i++){var cells=rows[i].split("="),key=cells[0],value=cells[1];key in parse&&parse[key](value)}callback()})}function sphericalToCartesian(RA,DEC,redshift){var theta=RA*(Math.PI/180),phi=DEC*(Math.PI/180);let r=lookUp(parseFloat(redshift));var sph_pos=new THREE.Spherical(r,phi,theta),x=sph_pos.radius*Math.cos(sph_pos.phi)*Math.sin(sph_pos.theta),y=sph_pos.radius*Math.cos(sph_pos.phi)*Math.cos(sph_pos.theta),z=sph_pos.radius*Math.sin(sph_pos.phi),cartesian_position;return new THREE.Vector3(x,y,z)}function zoomToGalaxy(){pos=currentGalaxy[0],poss=sphericalToCartesian(pos.RA,pos.DEC,.9*pos.redshift),camera.position.set(poss.x,poss.y,poss.z),camera.lookAt(pos.position.x,pos.position.y,pos.position.z)}function processGalaxyData(data){for(var n=data.length,positions=new Float32Array(3*n),selects=new Float32Array(1*n),colors=new Float32Array(1*n),visibles=new Float32Array(1*n),sizes=new Float32Array(n),i=0;i<n;++i){selects[i]=0,visibles[i]=1;let u=data[i];var vertex;new THREE.Vector3(data[i].position.x,data[i].position.y,data[i].position.z).toArray(positions,3*i),colors[i]="red"==u.color?0:"blue"==u.color?1:2,sizes[i]=u.rvir}var geometry=new THREE.BufferGeometry;geometry.addAttribute("position",new THREE.BufferAttribute(positions,3)),geometry.addAttribute("customColor",new THREE.BufferAttribute(colors,1)),geometry.addAttribute("isSelected",new THREE.BufferAttribute(selects,1)),geometry.addAttribute("isVisible",new THREE.BufferAttribute(visibles,1)),geometry.addAttribute("size",new THREE.BufferAttribute(sizes,1));var material=new THREE.ShaderMaterial({uniforms:{amplitude:{value:1},color:{value:new THREE.Color(16777215)},redColor:{value:new THREE.Color(galaxyRedHSL)},blueColor:{value:new THREE.Color(galaxyBlueHSL)},texture:{value:tex1},galaxyRvirScalar:{value:galaxyRvirScalar}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0});boxOfPoints=new THREE.Points(geometry,material),scene.add(boxOfPoints)}function filterBrushedGalaxies(){if(1==filterbyIP)for(let j=0;j<impactParameters.length;++j){let dist;impactParameters[j].smallestImpact/1e3<distanceFromSkewer&&galaxies[j].redshift>depthDomain[0]&&galaxies[j].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[j]=1:boxOfPoints.geometry.attributes.isVisible.array[j]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}else for(i=0;i<galaxies.length;i++)galaxies[i].redshift>depthDomain[0]&&galaxies[i].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[i]=1:boxOfPoints.geometry.attributes.isVisible.array[i]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}function filterGalaxiesNearSkewers(){filterbyIP=!0;for(let j=0,len=impactParameters.length;j<len;++j){let dist;impactParameters[j].smallestImpact/1e3<distanceFromSkewer&&galaxies[j].redshift>depthDomain[0]&&galaxies[j].redshift<depthDomain[1]?boxOfPoints.geometry.attributes.isVisible.array[j]=1:boxOfPoints.geometry.attributes.isVisible.array[j]=0,boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}}function unfilterGalaxiesNearSkewers(){filterbyIP=!1;for(var g=0,len=galaxies.length;g<len;g++)boxOfPoints.geometry.attributes.isVisible.array[g]=1;boxOfPoints.geometry.attributes.isVisible.needsUpdate=!0}function loadAllP(callback){if(!allLoaded)for(allLoaded=!0,n=0,len=skewer.length;n<len;n++)loadP(n);allLoaded=!0,callback()}function toggleGalaxiesNearSkewers(){(filterDistantGalaxies=!filterDistantGalaxies)?filterGalaxiesNearSkewers():unfilterGalaxiesNearSkewers()}function plotSkewer(name,RA,DEC){var cylMat=new THREE.ShaderMaterial({uniforms:{amplitude:{value:1},color:{value:new THREE.Color(16777215)},texture:{value:null}},vertexShader:document.getElementById("cyl_vertexshader").textContent,fragmentShader:document.getElementById("cyl_fragmentshader").textContent,depthTest:!0,transparent:!1,side:THREE.FrontSide});galaxy_redshift_min=galaxies.reduce((min,p)=>p.redshift<min?p.redshift:min,galaxies[0].redshift),galaxy_redshift_min<depthDomain[0]&&(depthDomain[0]=galaxy_redshift_min),galaxy_redshift_max=galaxies.reduce((max,p)=>p.redshift>max?p.redshift:max,galaxies[0].redshift),galaxy_redshift_max>depthDomain[1]&&(depthDomain[1]=galaxy_redshift_max);var startPoint=sphericalToCartesian(RA,DEC,galaxy_redshift_min).clone(),endPoint=sphericalToCartesian(RA,DEC,galaxy_redshift_max).clone(),cylLength=startPoint.distanceTo(endPoint),cylGeom=new THREE.CylinderBufferGeometry(skewerWidth,skewerWidth,cylLength,32,1,!0);cylGeom.translate(0,cylLength/2,0),cylGeom.rotateX(Math.PI/2),cylGeom.addAttribute("isSelected",new THREE.BufferAttribute(new Float32Array(192).fill(0),1));var cyl=new THREE.Mesh(cylGeom,cylMat);cyl.position.copy(startPoint),cyl.lookAt(endPoint),cyl.userData.name=name;var cyl2=new THREE.Mesh(cylGeom,cylMat);if(cyl2.position.copy(startPoint),cyl2.lookAt(endPoint),cylinderGroup.add(cyl),cylinderBackGroup.add(cyl2),showLabels){let sprite=new THREE.TextSprite({textSize:.5,redrawInterval:250,texture:{text:name,fontFamily:"Karla, Avenir, monospace, Arial, Helvetica, sans-serif",textAlign:"left"},material:{color:16777215,fog:!1,transparent:!0,opacity:.9}});sprite.position.setX(startPoint.x).setY(startPoint.y).setZ(startPoint.z),textGroup.add(sprite)}}function init(){var container;(renderer=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth-columnWidth,window.innerHeight-200),renderer.antialias=!0,camera=new THREE.PerspectiveCamera(54,(window.innerWidth-columnWidth)/(window.innerHeight-200),.01,1e4),(controls=new THREE.OrbitControls(camera,renderer.domElement)).enableDamping=!0,controls.maxAzimuthAngle=1/0,controls.maxPolarAngle=1/0,controls.dampingFactor=.4,camera.maxDistance=1/0,(scene=new THREE.Scene).background=new THREE.Color(328965),cylinderGroup=new THREE.Group,cylinderBackGroup=new THREE.Group,textGroup=new THREE.Group,scene.add(cylinderGroup),scene.add(cylinderBackGroup),scene.add(textGroup),processOptions(()=>{loadGalaxyData(()=>loadSkewerData()),displayGui()}),createBrush(),createSlider(),window.addEventListener("resize",onWindowResize,!1),document.addEventListener("mousemove",onMouseMove,!1),window.addEventListener("wheel",onMouseWheel,!1),document.addEventListener("keydown",onKeyDown,!1),document.getElementById("container").appendChild(renderer.domElement),EW_plot_init()}function onMouseWheel(event){let x=event.clientX,y=event.clientY;if(mouse.x=x/(window.innerWidth-columnWidth)*2-1,mouse.y=-y/(window.innerHeight-200)*2+1,mouse.y>-1&&mouse.x<1){var factor=4,vector=new THREE.Vector3(mouse.x,mouse.y,1);vector.unproject(camera),vector.sub(camera.position),event.deltaY<0?(camera.position.addVectors(camera.position,vector.setLength(4)),controls.target.addVectors(controls.target,vector.setLength(4))):(camera.position.subVectors(camera.position,vector.setLength(4)),controls.target.subVectors(controls.target,vector.setLength(4)))}}function displayGui(){(gui=new dat.GUI({width:columnWidth/2})).domElement.id="dat-gui";var galRed=new THREE.Color(galaxyRedHSL),galBlue=new THREE.Color(galaxyBlueHSL),skewMinHSL=new THREE.Color(skewerAbsorptionMinHSL),skewMaxHSL=new THREE.Color(skewerAbsorptionMaxHSL);guiParams={galNearSkewer:!1,galDist2Skewer:distanceFromSkewer,galRvirScal:galaxyRvirScalar,galRedHSL:[255*galRed.r,255*galRed.g,255*galRed.b],galBlueHSL:[255*galBlue.r,255*galBlue.g,255*galBlue.b],skewerAbsorMinHSL:[255*skewMinHSL.r,255*skewMinHSL.g,255*skewMinHSL.b],skewerAbsorMaxHSL:[255*skewMaxHSL.r,255*skewMaxHSL.g,255*skewMaxHSL.b],skewersVisible:function(){cylinderGroup.visible=!cylinderGroup.visible,cylinderBackGroup.visible=!cylinderBackGroup.visible},textVisible:function(){textGroup.visible=!textGroup.visible}};var galaxyFolder=gui.addFolder("Galaxies"),galaxyRvirSc=galaxyFolder.add(guiParams,"galRvirScal",galaxyRvirScalar/2,10*galaxyRvirScalar).name("Rvir Scalar"),galaxyRed=galaxyFolder.addColor(guiParams,"galRedHSL").name("Red Value"),galaxyBlue=galaxyFolder.addColor(guiParams,"galBlueHSL").name("Blue Value"),skewerFolder=gui.addFolder("Skewers"),skewerVis=skewerFolder.add(guiParams,"skewersVisible").name("Toggle Skewer Visibility"),textVis=skewerFolder.add(guiParams,"textVisible").name("Toggle Text Visibility"),skewerMinAbs=skewerFolder.addColor(guiParams,"skewerAbsorMinHSL").name("Minimum Absorption"),skewerMaxAbs=skewerFolder.addColor(guiParams,"skewerAbsorMaxHSL").name("Maximum Absorption");galaxyRvirSc.onChange(function(value){boxOfPoints.material.uniforms.galaxyRvirScalar.value=value}),galaxyRed.onChange(function(value){boxOfPoints.material.uniforms.redColor.value=new THREE.Color(value[0]/255,value[1]/255,value[2]/255)}),galaxyBlue.onChange(function(value){boxOfPoints.material.uniforms.blueColor.value=new THREE.Color(value[0]/255,value[1]/255,value[2]/255)}),skewerMinAbs.onChange(function(value){skewerAbsorptionMinHSL="rgb("+Math.round(value[0])+" ,"+Math.round(value[1])+" ,"+Math.round(value[2])+")";for(var i=0,len=cylinderGroup.children.length;i<len;i++)createAbsorptionDataTexture(skewer[i])}),skewerMaxAbs.onChange(function(value){skewerAbsorptionMaxHSL="rgb("+Math.round(value[0])+", "+Math.round(value[1])+", "+Math.round(value[2])+")";for(var i=0,len=cylinderGroup.children.length;i<len;i++)createAbsorptionDataTexture(skewer[i])}),galaxyFolder.open(),skewerFolder.open(),gui.close();let orbitOff=()=>{controls.enabled=!1,controls.update()},orbitOn=()=>{controls.enabled=!0,controls.update()};["dat-gui","details"].forEach(id=>{let dg=document.getElementById(id);dg.onmouseover=orbitOff,dg.onmouseout=orbitOn});let close=document.getElementsByClassName("close-button");document.getElementById("dat-gui").prepend(close[0])}function onWindowResize(){columnWidth=window.innerWidth/3;var canvas=document.getElementsByTagName("canvas")[0];canvas.width=window.innerWidth-columnWidth,canvas.height=window.innerHeight-200,renderer.setSize(window.innerWidth-columnWidth,window.innerHeight-200),camera.aspect=(window.innerWidth-columnWidth)/(window.innerHeight-200),camera.updateProjectionMatrix();let n=graphs.length;for(w=0;w<n;w++)d3.select("#details").selectAll("#graph"+w).remove();d3.select("#depth-brush").empty(),graphs=createGraph(n_skewers),plotSkewerSpectra(xScale,yScale),plotSkewerSpectra(),EW_plot_init(),EW_plot()}function animate(){target.x=.002*(1-mouse.x),target.y=.002*(1-mouse.y),camera.rotation.x+=.05*(target.y-camera.rotation.x),camera.rotation.y+=.05*(target.x-camera.rotation.y),requestAnimationFrame(animate),controls.update(),renderer.render(scene,camera)}function createAbsorptionDataTexture(name){let v=skewerData.get(name),c=cylinderGroup.children[skewer.indexOf(name)];if(v&&v.HI){let absorptionData=skewerData.get(name).HI.map(u=>u.flux_norm);for(var resY=absorptionData.length-1,data=new Uint8Array(4*resY),colorMin=new THREE.Color(skewerAbsorptionMinHSL),colorMax=new THREE.Color(skewerAbsorptionMaxHSL),minHSL=colorMin.getHSL(),maxHSL=colorMax.getHSL(),colorVal=new THREE.Color(0,0,0),i=0,texture;i<resY;i++){var ar=absorptionData[i]-1,lerpVal;ar<0?(lerpVal=-1*ar,colorVal.setHSL(minHSL.h,minHSL.s,lerpVal+.2)):colorVal.setHSL(maxHSL.h,maxHSL.s,lerpVal+.2);var stride=4*i;data[stride]=parseInt(255*colorVal.r),data[stride+1]=parseInt(255*colorVal.g),data[stride+2]=parseInt(255*colorVal.b),data[stride+3]=255}(texture=skewerLinearFiltering?new THREE.DataTexture(data,1,resY,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter):new THREE.DataTexture(data,1,resY,THREE.RGBAFormat)).needsUpdate=!0,c.material.uniforms.texture.value=texture}}